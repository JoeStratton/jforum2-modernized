{
  "pageContent": "File Path: src/net/jforum/view/admin/ForumAction.java\n\n Original Content: public class ForumAction extends AdminCommand \n{\n\t// Listing\n\tpublic void list()\n\t{\n\t\tthis.context.put(\"categories\", DataAccessDriver.getInstance().newCategoryDAO().selectAll());\n\t\tthis.context.put(\"repository\", new ForumRepository());\n\t\tthis.setTemplateName(TemplateKeys.FORUM_ADMIN_LIST);\n\t}\n\t\n\t// One more, one more\n\tpublic void insert()\n\t{\n\t\tCategoryDAO cm = DataAccessDriver.getInstance().newCategoryDAO();\n\t\t\n\t\tthis.context.put(\"groups\", new TreeGroup().getNodes());\n\t\tthis.context.put(\"selectedList\", new ArrayList());\n\t\tthis.setTemplateName(TemplateKeys.FORUM_ADMIN_INSERT);\n\t\tthis.context.put(\"categories\",cm.selectAll());\n\t\tthis.context.put(\"action\", \"insertSave\");\t\t\n\t}\n\t\n\t// Edit\n\tpublic void edit()\n\t{\n\t\tint forumId = this.request.getIntParameter(\"forum_id\");\n\t\tForumDAO forumDao = DataAccessDriver.getInstance().newForumDAO();\n\t\t\n\t\tCategoryDAO cm = DataAccessDriver.getInstance().newCategoryDAO();\n\t\t\n\t\tthis.setTemplateName(TemplateKeys.FORUM_ADMIN_EDIT);\n\t\tthis.context.put(\"categories\", cm.selectAll());\n\t\tthis.context.put(\"action\", \"editSave\");\n\t\tthis.context.put(\"forum\", forumDao.selectById(forumId));\n\t\t\n\t\t// Mail Integration\n\t\t// MailIntegrationDAO integrationDao = DataAccessDriver.getInstance().newMailIntegrationDAO();\n\t\t// this.context.put(\"mailIntegration\", integrationDao.find(forumId));\n\t}\n\t\n\tpublic void editSave()\n\t{\n\t\tForumDAO forumDao = DataAccessDriver.getInstance().newForumDAO();\n\t\tForum f = forumDao.selectById(this.request.getIntParameter(\"forum_id\"));\n\t\t\n\t\tboolean moderated = f.isModerated();\n\t\tint categoryId = f.getCategoryId();\n\t\t\n\t\tf.setDescription(this.request.getParameter(\"description\"));\n\t\tf.setIdCategories(this.request.getIntParameter(\"categories_id\"));\n\t\tf.setName(this.request.getParameter(\"forum_name\"));\n\t\tf.setModerated(\"1\".equals(this.request.getParameter(\"moderate\")));\n\n\t\tforumDao.update(f);\n\n\t\tif (moderated != f.isModerated()) {\n\t\t\tnew ModerationCommon().setTopicModerationStatus(f.getId(), f.isModerated());\n\t\t}\n\t\t\n\t\tif (categoryId != f.getCategoryId()) {\n\t\t\tf.setIdCategories(categoryId);\n\t\t\tForumRepository.removeForum(f);\n\t\t\t\n\t\t\tf.setIdCategories(this.request.getIntParameter(\"categories_id\"));\n\t\t\tForumRepository.addForum(f);\n\t\t}\n\t\telse {\n\t\t\tForumRepository.reloadForum(f.getId());\n\t\t}\n\t\t\n\t\t//this.handleMailIntegration();\n\t\t\n\t\tthis.list();\n\t}\n\t\n\tprivate void handleMailIntegration()\n\t{\n\t\tint forumId = this.request.getIntParameter(\"forum_id\");\n\t\tMailIntegrationDAO dao = DataAccessDriver.getInstance().newMailIntegrationDAO();\n\t\t\n\t\tif (!\"1\".equals(this.request.getParameter(\"mail_integration\"))) {\n\t\t\tdao.delete(forumId);\n\t\t}\n\t\telse {\n\t\t\tboolean exists = dao.find(forumId) != null;\n\t\t\t\n\t\t\tMailIntegration m = this.fillMailIntegrationFromRequest();\n\t\t\t\n\t\t\tif (exists) {\n\t\t\t\tdao.update(m);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tdao.add(m);\n\t\t\t}\n\t\t}\n\t}\n\t\n\tprivate MailIntegration fillMailIntegrationFromRequest()\n\t{\n\t\tMailIntegration m = new MailIntegration();\n\t\t\n\t\tm.setForumId(this.request.getIntParameter(\"forum_id\"));\n\t\tm.setForumEmail(this.request.getParameter(\"forum_email\"));\n\t\tm.setPopHost(this.request.getParameter(\"pop_host\"));\n\t\tm.setPopUsername(this.request.getParameter(\"pop_username\"));\n\t\tm.setPopPassword(this.request.getParameter(\"pop_password\"));\n\t\tm.setPopPort(this.request.getIntParameter(\"pop_port\"));\n\t\tm.setSSL(\"1\".equals(this.request.getParameter(\"requires_ssl\")));\n\t\t\n\t\treturn m;\n\t}\n\t\n\tpublic void up()\n\t{\n\t\tthis.processOrdering(true);\n\t}\n\t\n\tpublic void down()\n\t{\n\t\tthis.processOrdering(false);\n\t}\n\t\n\tprivate void processOrdering(boolean up)\n\t{\n\t\tForum toChange = new Forum(ForumRepository.getForum(Integer.parseInt(\n\t\t\t\tthis.request.getParameter(\"forum_id\"))));\n\t\t\n\t\tCategory category = ForumRepository.getCategory(toChange.getCategoryId());\n\t\tList forums = new ArrayList(category.getForums());\n\t\tint index = forums.indexOf(toChange);\n\t\t\n\t\tif (index == -1 || (up && index == 0) || (!up && index + 1 == forums.size())) {\n\t\t\tthis.list();\n\t\t\treturn;\n\t\t}\n\t\t\n\t\tForumDAO fm = DataAccessDriver.getInstance().newForumDAO();\n\t\t\n\t\tif (up) {\n\t\t\t// Get the forum which comes *before* the forum we're changing\n\t\t\tForum otherForum = new Forum((Forum)forums.get(index - 1));\n\t\t\tfm.setOrderUp(toChange, otherForum);\n\t\t}\n\t\telse {\n\t\t\t// Get the forum which comes *after* the forum we're changing\n\t\t\tForum otherForum = new Forum((Forum)forums.get(index + 1));\n\t\t\tfm.setOrderDown(toChange, otherForum);\n\t\t}\n\t\t\n\t\tcategory.changeForumOrder(toChange);\n\t\tForumRepository.refreshCategory(category);\n\t\t\n\t\tthis.list();\n\t}\n\t\n\t// Delete\n\tpublic void delete()\n\t{\n\t\tString ids[] = this.request.getParameterValues(\"forum_id\");\n\t\t\n\t\tForumDAO forumDao = DataAccessDriver.getInstance().newForumDAO();\n\t\tTopicDAO topicDao = DataAccessDriver.getInstance().newTopicDAO();\n\t\t\n\t\tif (ids != null) {\n\t\t\tfor (int i = 0; i < ids.length; i++) {\n\t\t\t\tint forumId = Integer.parseInt(ids[i]);\n\n\t\t\t\ttopicDao.deleteByForum(forumId);\n\t\t\t\tforumDao.delete(forumId);\n\t\t\t\t\n\t\t\t\tForum f = new Forum(ForumRepository.getForum(forumId));\n\t\t\t\tForumRepository.removeForum(f);\n\t\t\t}\n\t\t\t\n\t\t\tSecurityRepository.clean();\n\t\t\tRolesRepository.clear();\n\t\t}\n\t\t\n\t\tthis.list();\n\t}\n\t\n\t// A new one\n\tpublic void insertSave()\n\t{\n\t\tForum f = new Forum();\n\t\tf.setDescription(this.request.getParameter(\"description\"));\n\t\tf.setIdCategories(this.request.getIntParameter(\"categories_id\"));\n\t\tf.setName(this.request.getParameter(\"forum_name\"));\t\n\t\tf.setModerated(\"1\".equals(this.request.getParameter(\"moderate\")));\n\t\t\t\n\t\tint forumId = DataAccessDriver.getInstance().newForumDAO().addNew(f);\n\t\tf.setId(forumId);\n\t\t\n\t\tForumRepository.addForum(f);\n\t\t\n\t\tGroupSecurityDAO gmodel = DataAccessDriver.getInstance().newGroupSecurityDAO();\n\t\tPermissionControl pc = new PermissionControl();\n\t\tpc.setSecurityModel(gmodel);\n\t\t\n\t\tString[] allGroups = this.request.getParameterValues(\"groups\");\n\t\t\n\t\t// Access\n\t\tString[] groups = this.request.getParameterValues(\"groupsAccess\");\n\t\tif (groups != null) {\n\t\t\tthis.addRole(pc, SecurityConstants.PERM_FORUM, f.getId(), groups);\n\t\t}\n\t\telse {\n\t\t\tthis.addRole(pc, SecurityConstants.PERM_FORUM, f.getId(), allGroups);\n\t\t}\n\t\t\n\t\t// Anonymous posts\n\t\tgroups = this.request.getParameterValues(\"groupsAnonymous\");\n\t\tif (groups != null) {\n\t\t\tthis.addRole(pc, SecurityConstants.PERM_ANONYMOUS_POST, f.getId(), groups);\n\t\t}\n\t\telse {\n\t\t\tthis.addRole(pc, SecurityConstants.PERM_ANONYMOUS_POST, f.getId(), allGroups);\n\t\t}\n\t\t\n\t\t// Read-only\n\t\tgroups = this.request.getParameterValues(\"groupsReadOnly\");\n\t\tif (groups != null) {\n\t\t\tthis.addRole(pc, SecurityConstants.PERM_READ_ONLY_FORUMS, f.getId(), groups);\n\t\t}\n\t\telse {\n\t\t\tthis.addRole(pc, SecurityConstants.PERM_READ_ONLY_FORUMS, f.getId(), allGroups);\n\t\t}\n\t\t\n\t\t// Reply-only\n\t\tthis.addRole(pc, SecurityConstants.PERM_REPLY_ONLY, f.getId(), allGroups);\n\t\t\n\t\t// HTML\n\t\tgroups = this.request.getParameterValues(\"groupsHtml\");\n\t\tif (groups != null) {\n\t\t\tthis.addRole(pc, SecurityConstants.PERM_HTML_DISABLED, f.getId(), groups);\n\t\t}\n\t\telse {\n\t\t\tthis.addRole(pc, SecurityConstants.PERM_HTML_DISABLED, f.getId(), allGroups);\n\t\t}\n\t\t\n\t\tSecurityRepository.clean();\n\t\tRolesRepository.clear();\n\t\t\n\t\t//this.handleMailIntegration();\n\n\t\tthis.list();\n\t}\n\t\n\tprivate void addRole(PermissionControl pc, String roleName, int forumId, String[] groups) \n\t{\n\t\tRole role = new Role();\n\t\trole.setName(roleName);\n\t\t\n\t\tfor (int i = 0; i < groups.length; i++) {\n\t\t\tint groupId = Integer.parseInt(groups[i]);\n\t\t\tRoleValueCollection roleValues = new RoleValueCollection();\n\t\t\t\n\t\t\tRoleValue rv = new RoleValue();\n\t\t\trv.setValue(Integer.toString(forumId));\n\t\t\troleValues.add(rv);\n\t\t\t\n\t\t\tpc.addRoleValue(groupId, role, roleValues);\n\t\t}\n\t}\n}",
  "metadata": {
    "fileId": "ForumAction_java_chunk_2",
    "fileName": "ForumAction.java",
    "filePath": "src/net/jforum/view/admin/ForumAction.java"
  }
}