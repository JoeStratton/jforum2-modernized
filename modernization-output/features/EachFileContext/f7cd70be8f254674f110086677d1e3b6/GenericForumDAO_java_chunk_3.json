{
  "pageContent": "File Path: src/net/jforum/dao/generic/GenericForumDAO.java\n\n Original Content: return (tryFix ? this.getLastPostInfo(forumId, false) : lpi);\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(rs, p);\n\t\t}\n\t}\n\n\t/**\n\t * @see net.jforum.dao.ForumDAO#getLastPostInfo(int)\n\t */\n\tpublic LastPostInfo getLastPostInfo(int forumId)\n\t{\n\t\treturn this.getLastPostInfo(forumId, true);\n\t}\n\n\t/**\n\t * @see net.jforum.dao.ForumDAO#getModeratorList(int)\n\t */\n\tpublic List getModeratorList(int forumId)\n\t{\n\t\tList l = new ArrayList();\n\n\t\tPreparedStatement p = null;\n\t\tResultSet rs = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(\n\t\t\t\t\tSystemGlobals.getSql(\"ForumModel.getModeratorList\"));\n\t\t\tp.setInt(1, forumId);\n\n\t\t\trs = p.executeQuery();\n\n\t\t\twhile (rs.next()) {\n\t\t\t\tModeratorInfo mi = new ModeratorInfo();\n\n\t\t\t\tmi.setId(rs.getInt(\"id\"));\n\t\t\t\tmi.setName(rs.getString(\"name\"));\n\n\t\t\t\tl.add(mi);\n\t\t\t}\n\n\t\t\treturn l;\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(rs, p);\n\t\t}\n\t}\n\n\t/**\n\t * @see net.jforum.dao.ForumDAO#getTotalMessages()\n\t */\n\tpublic int getTotalMessages()\n\t{\n\t\tPreparedStatement p = null;\n\t\tResultSet rs = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(\n\t\t\t\t\tSystemGlobals.getSql(\"ForumModel.totalMessages\"));\n\t\t\trs = p.executeQuery();\n\n\t\t\tif (rs.next()) {\n\t\t\t\treturn rs.getInt(\"total_messages\");\n\t\t\t}\n\n\t\t\treturn 0;\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(rs, p);\n\t\t}\n\t}\n\n\t/**\n\t * @see net.jforum.dao.ForumDAO#getTotalTopics(int)\n\t */\n\tpublic int getTotalTopics(int forumId)\n\t{\n\t\tint total = 0;\n\t\tPreparedStatement p = null;\n\t\tResultSet rs = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(\n\t\t\t\t\tSystemGlobals.getSql(\"ForumModel.getTotalTopics\"));\n\t\t\tp.setInt(1, forumId);\n\t\t\trs = p.executeQuery();\n\n\t\t\tif (rs.next()) {\n\t\t\t\ttotal = rs.getInt(1);\n\t\t\t}\n\n\t\t\treturn total;\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(rs, p);\n\t\t}\n\t}\n\n\t/**\n\t * @see net.jforum.dao.ForumDAO#getMaxPostId(int)\n\t */\n\tpublic int getMaxPostId(int forumId)\n\t{\n\t\tint id = -1;\n\n\t\tPreparedStatement p = null;\n\t\tResultSet rs = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection()\n\t\t\t\t\t.prepareStatement(SystemGlobals.getSql(\"ForumModel.getMaxPostId\"));\n\t\t\tp.setInt(1, forumId);\n\n\t\t\trs = p.executeQuery();\n\t\t\tif (rs.next()) {\n\t\t\t\tid = rs.getInt(\"post_id\");\n\t\t\t}\n\n\t\t\treturn id;\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(rs, p);\n\t\t}\n\t}\n\n\t/**\n\t * @see net.jforum.dao.ForumDAO#moveTopics(java.lang.String[], int, int)\n\t */\n\tpublic void moveTopics(String[] topics, int fromForumId, int toForumId)\n\t{\n\t\tPreparedStatement p = null;\n\t\tPreparedStatement t = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(SystemGlobals.getSql(\"ForumModel.moveTopics\"));\n\t\t\tt = JForumExecutionContext.getConnection().prepareStatement(\n\t\t\t\tSystemGlobals.getSql(\"PostModel.setForumByTopic\"));\n\n\t\t\tp.setInt(1, toForumId);\n\t\t\tp.setInt(2, fromForumId);\n\t\t\t\n\t\t\tt.setInt(1, toForumId);\n\n\t\t\tTopicDAO tdao = DataAccessDriver.getInstance().newTopicDAO();\n\n\t\t\tForum f = this.selectById(toForumId);\n\n\t\t\tfor (int i = 0; i < topics.length; i++) {\n\t\t\t\tint topicId = Integer.parseInt(topics[i]);\n\t\t\t\tp.setInt(3, topicId);\n\t\t\t\tt.setInt(2, topicId);\n\n\t\t\t\tp.executeUpdate();\n\t\t\t\tt.executeUpdate();\n\n\t\t\t\ttdao.setModerationStatusByTopic(topicId, f.isModerated());\n\t\t\t}\n\n\t\t\tthis.decrementTotalTopics(fromForumId, topics.length);\n\t\t\tthis.incrementTotalTopics(toForumId, topics.length);\n\n\t\t\tthis.setLastPost(fromForumId, this.getMaxPostId(fromForumId));\n\t\t\tthis.setLastPost(toForumId, this.getMaxPostId(toForumId));\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(p);\n\t\t\tDbUtils.close(t);\n\t\t}\n\t}\n\n\t/**\n\t * @see net.jforum.dao.ForumDAO#hasUnreadTopics(int, long)\n\t */\n\tpublic List checkUnreadTopics(int forumId, long lastVisit)\n\t{\n\t\tList l = new ArrayList();\n\n\t\tPreparedStatement p = null;\n\t\tResultSet rs = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(\n\t\t\t\t\tSystemGlobals.getSql(\"ForumModel.checkUnreadTopics\"));\n\t\t\tp.setInt(1, forumId);\n\t\t\tp.setTimestamp(2, new Timestamp(lastVisit));\n\n\t\t\trs = p.executeQuery();\n\t\t\twhile (rs.next()) {\n\t\t\t\tTopic t = new Topic();\n\t\t\t\tt.setId(rs.getInt(\"topic_id\"));\n\t\t\t\tt.setTime(new Date(rs.getTimestamp(1).getTime()));\n\n\t\t\t\tl.add(t);\n\t\t\t}\n\n\t\t\treturn l;\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(rs, p);\n\t\t}\n\t}\n\n\t/**\n\t * @see net.jforum.dao.ForumDAO#setModerated(int, boolean)\n\t */\n\tpublic void setModerated(int categoryId, boolean status)\n\t{\n\t\tPreparedStatement p = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection()\n\t\t\t\t\t.prepareStatement(SystemGlobals.getSql(\"ForumModel.setModerated\"));\n\t\t\tp.setInt(1, status ? 1 : 0);\n\t\t\tp.setInt(2, categoryId);\n\t\t\tp.executeUpdate();\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(p);\n\t\t}\n\t}\n\n\t/**\n\t * @see net.jforum.dao.ForumDAO#getBoardStatus()\n\t */\n\tpublic ForumStats getBoardStatus()\n\t{\n\t\tForumStats fs = new ForumStats();\n\t\tfs.setPosts(this.getTotalMessages());\n\n\t\tConnection c = JForumExecutionContext.getConnection();\n\n\t\t// Total Users\n\t\tStatement s = null;\n\t\tResultSet rs = null;\n\n\t\ttry {\n\t\t\ts = c.createStatement();\n\t\t\trs = s.executeQuery(SystemGlobals.getSql(\"UserModel.totalUsers\"));\n\t\t\trs.next();\n\t\t\tfs.setUsers(rs.getInt(1));\n\t\t\trs.close();\n\t\t\trs = null;\n\t\t\ts.close();\n\t\t\ts = null;\n\n\t\t\t// Total Topics\n\t\t\ts = c.createStatement();\n\t\t\trs = s.executeQuery(SystemGlobals.getSql(\"TopicModel.totalTopics\"));\n\t\t\trs.next();\n\t\t\tfs.setTopics(rs.getInt(1));\n\t\t\trs.close();\n\t\t\trs = null;\n\t\t\ts.close();\n\t\t\ts = null;\n\n\t\t\t// Posts per day\n\t\t\tdouble postPerDay = 0;\n\t\t\t\n\t\t\t// Topics per day\n\t\t\tdouble topicPerDay = 0;\n\t\t\t\n\t\t\t// user per day\n\t\t\tdouble userPerDay = 0;\n\n\t\t\ts = c.createStatement();\n\t\t\trs = s.executeQuery(SystemGlobals.getSql(\"ForumModel.statsFirstPostTime\"));\n\t\t\tif (rs.next()) {\n\n\t\t\t\tTimestamp firstTime = rs.getTimestamp(1);\n\t\t\t\tif (rs.wasNull()) {\n\t\t\t\t\tfirstTime = null;\n\t\t\t\t}\n\t\t\t\trs.close();\n\t\t\t\trs = null;\n\t\t\t\ts.close();\n\t\t\t\ts = null;\n\n\t\t\t\tDate today = new Date();\n\n\t\t\t\tpostPerDay = firstTime != null ? fs.getPosts() / this.daysUntilToday(today, firstTime) : 0;\n\n\t\t\t\tif (fs.getPosts() > 0 && postPerDay < 1) {\n\t\t\t\t\tpostPerDay = 1;\n\t\t\t\t}\n\n\t\t\t\ttopicPerDay = firstTime != null ? fs.getTopics() / this.daysUntilToday(today, firstTime) : 0;\n\n\t\t\t\t// Users per day\n\t\t\t\ts = c.createStatement();\n\t\t\t\trs = s.executeQuery(SystemGlobals.getSql(\"ForumModel.statsFirstRegisteredUserTime\"));\n\t\t\t\tif (rs.next()) {\n\t\t\t\t\tfirstTime = rs.getTimestamp(1);\n\t\t\t\t\tif (rs.wasNull()) {\n\t\t\t\t\t\tfirstTime = null;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\trs.close();\n\t\t\t\trs = null;\n\t\t\t\ts.close();\n\t\t\t\ts = null;\n\n\t\t\t\tuserPerDay = firstTime != null ? fs.getUsers() / this.daysUntilToday(today, firstTime) : 0;\n\t\t\t}\n\n\t\t\tfs.setPostsPerDay(postPerDay);\n\t\t\tfs.setTopicsPerDay(topicPerDay);\n\t\t\tfs.setUsersPerDay(userPerDay);\n\n\t\t\treturn fs;\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(rs, s);\n\t\t}\n\t}\n\n\tprivate int daysUntilToday(Date today, Date from)\n\t{\n\t\tint days = (int) ((today.getTime() - from.getTime()) / (24 * 60 * 60 * 1000));\n\t\treturn days == 0 ? 1 : days;\n\t}\n\n\t/**\n\t * This code is writen by looking at GenericTopicDAO.java\n\t * \n\t * @see\n\t */\n\tpublic List notifyUsers(Forum forum)\n\t{\n\t\tint posterId = SessionFacade.getUserSession().getUserId();\n\t\tint anonUser = SystemGlobals.getIntValue(ConfigKeys.ANONYMOUS_USER_ID);\n\n\t\tPreparedStatement p = null;\n\t\tResultSet rs = null;\n\t\t\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(\n\t\t\t\t\tSystemGlobals.getSql(\"ForumModel.notifyUsers\"));\n\n\t\t\tp.setInt(1, forum.getId());\n\t\t\tp.setInt(2, posterId); // don't notify the poster\n\t\t\tp.setInt(3, anonUser); // don't notify the anonimous user\n\n\t\t\trs = p.executeQuery();\n\t\t\tList users = new ArrayList();\n\t\t\t\n\t\t\twhile (rs.next()) {\n\t\t\t\tUser user = new User();\n\n\t\t\t\tuser.setId(rs.getInt(\"user_id\"));\n\t\t\t\tuser.setEmail(rs.getString(\"user_email\"));\n\t\t\t\tuser.setUsername(rs.getString(\"username\"));\n\t\t\t\tuser.setLang(rs.getString(\"user_lang\"));\n\t\t\t\tuser.setNotifyAlways(rs.getInt(\"user_notify_always\") == 1);\n\t\t\t\tuser.setNotifyText(rs.getInt(\"user_notify_text\") == 1);\n\n\t\t\t\tusers.add(user);\n\t\t\t}\n\t\t\t\n\t\t\treturn users;\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(rs, p);\n\t\t}\n\n\t}\n\n\tpublic void subscribeUser(int forumId, int userId)\n\t{\n\t\tPreparedStatement p = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(\n\t\t\t\t\tSystemGlobals.getSql(\"ForumModel.subscribeUser\"));\n\n\t\t\tp.setInt(1, forumId);\n\t\t\tp.setInt(2, userId);\n\n\t\t\tp.executeUpdate();\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(p);\n\t\t}\n\n\t}\n\n\tpublic boolean isUserSubscribed(int forumId, int userId)\n\t{\n\t\tPreparedStatement stmt = null;\n\t\tResultSet rs = null;\n\t\ttry {\n\t\t\tstmt = JForumExecutionContext.getConnection().prepareStatement(\n\t\t\t\t\tSystemGlobals.getSql(\"ForumModel.isUserSubscribed\"));\n\n\t\t\tstmt.setInt(1, forumId);\n\t\t\tstmt.setInt(2, userId);\n\n\t\t\trs = stmt.executeQuery();\n\n\t\t\treturn rs.next();\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(rs, stmt);\n\t\t}\n\t}\n\n\tpublic void removeSubscription(int forumId, int userId)\n\t{\n\t\tPreparedStatement p = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(\n\t\t\t\t\tSystemGlobals.getSql(\"ForumModel.removeSubscription\"));\n\t\t\tp.setInt(1, forumId);\n\t\t\tp.setInt(2, userId);\n\n\t\t\tp.executeUpdate();\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(p);\n\t\t}\n\n\t}",
  "metadata": {
    "fileId": "GenericForumDAO_java_chunk_3",
    "fileName": "GenericForumDAO.java",
    "filePath": "src/net/jforum/dao/generic/GenericForumDAO.java"
  }
}