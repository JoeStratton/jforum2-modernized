{
  "pageContent": "File Path: src/net/jforum/dao/generic/GenericTopicDAO.java\n\n Original Content: /**\n\t * Fills all topic data. The method will try to get all fields from the topics table, as well\n\t * information about the user who made the first and the last post in the topic. <br>\n\t * <b>The method <i>will</i> close the <i>PreparedStatement</i></b>\n\t * \n\t * @param p the PreparedStatement to execute\n\t * @return A list with all topics found\n\t * @throws SQLException\n\t */\n\tpublic List fillTopicsData(PreparedStatement p)\n\t{\n\t\tList l = new ArrayList();\n\t\tResultSet rs = null;\n\t\t\n\t\ttry {\n\t\t\trs = p.executeQuery();\n\n\t\t\tSimpleDateFormat df = new SimpleDateFormat(SystemGlobals.getValue(ConfigKeys.DATE_TIME_FORMAT));\n\n\t\t\tStringBuffer sbFirst = new StringBuffer(128);\n\t\t\tStringBuffer sbLast = new StringBuffer(128);\n\n\t\t\twhile (rs.next()) {\n\t\t\t\tTopic t = this.getBaseTopicData(rs);\n\n\t\t\t\t// Posted by\n\t\t\t\tUser u = new User();\n\t\t\t\tu.setId(rs.getInt(\"user_id\"));\n\t\t\t\tt.setPostedBy(u);\n\n\t\t\t\t// Last post by\n\t\t\t\tu = new User();\n\t\t\t\tu.setId(rs.getInt(\"last_user_id\"));\n\t\t\t\tt.setLastPostBy(u);\n\n\t\t\t\tt.setHasAttach(rs.getInt(\"attach\") > 0);\n\t\t\t\tt.setFirstPostTime(df.format(rs.getTimestamp(\"topic_time\")));\n\t\t\t\tt.setLastPostTime(df.format(rs.getTimestamp(\"post_time\")));\n\t\t\t\tt.setLastPostDate(new Date(rs.getTimestamp(\"post_time\").getTime()));\n\n\t\t\t\tl.add(t);\n\n\t\t\t\tsbFirst.append(rs.getInt(\"user_id\")).append(',');\n\t\t\t\tsbLast.append(rs.getInt(\"last_user_id\")).append(',');\n\t\t\t}\n\n\t\t\trs.close();\n\t\t\trs = null;\n\t\t\tp.close();\n\t\t\tp = null;\n\n\t\t\t// Users\n\t\t\tif (sbFirst.length() > 0) {\n\t\t\t\tsbLast.delete(sbLast.length() - 1, sbLast.length());\n\n\t\t\t\tString sql = SystemGlobals.getSql(\"TopicModel.getUserInformation\");\n\t\t\t\tsql = sql.replaceAll(\"#ID#\", sbFirst.toString() + sbLast.toString());\n\n\t\t\t\tMap users = new HashMap();\n\n\t\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(sql);\n\t\t\t\trs = p.executeQuery();\n\n\t\t\t\twhile (rs.next()) {\n\t\t\t\t\tusers.put(new Integer(rs.getInt(\"user_id\")), rs.getString(\"username\"));\n\t\t\t\t}\n\n\t\t\t\trs.close();\n\t\t\t\trs = null;\n\t\t\t\tp.close();\n\t\t\t\tp = null;\n\n\t\t\t\tfor (Iterator iter = l.iterator(); iter.hasNext();) {\n\t\t\t\t\tTopic t = (Topic) iter.next();\n\t\t\t\t\tt.getPostedBy().setUsername((String) users.get(new Integer(t.getPostedBy().getId())));\n\t\t\t\t\tt.getLastPostBy().setUsername((String) users.get(new Integer(t.getLastPostBy().getId())));\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn l;\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(rs, p);\n\t\t}\n\t}\n\n\t/**\n\t * @see net.jforum.dao.TopicDAO#selectRecentTopics(int)\n\t */\n\tpublic List selectRecentTopics(int limit)\n\t{\n\t\tPreparedStatement p = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(\n\t\t\t\tSystemGlobals.getSql(\"TopicModel.selectRecentTopicsByLimit\"));\n\t\t\tp.setInt(1, limit);\n\n\t\t\tList list = this.fillTopicsData(p);\n\t\t\treturn list;\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(p);\n\t\t}\n\t}\n\n\t/**\n\t * @see net.jforum.dao.TopicDAO#selectHottestTopics(int)\n\t */\n\tpublic List selectHottestTopics(int limit)\n\t{\n\t    PreparedStatement p = null;\n\t    try {\n\t        p = JForumExecutionContext.getConnection().prepareStatement(\n\t        \tSystemGlobals.getSql(\"TopicModel.selectHottestTopicsByLimit\"));\n\t        p.setInt(1, limit);\n\t  \n\t        List list = this.fillTopicsData(p);\n\t        p = null;\n\t        return list;\n\t    }\n\t    catch (SQLException e) {\n\t        throw new DatabaseException(e);\n\t    }\n\t    finally {\n\t        DbUtils.close(p);\n\t    }\n\t}\n\t\n\t/**\n\t * @see net.jforum.dao.TopicDAO#setFirstPostId(int, int)\n\t */\n\tpublic void setFirstPostId(int topicId, int postId)\n\t{\n\t\tPreparedStatement p = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(\n\t\t\t\t\tSystemGlobals.getSql(\"TopicModel.setFirstPostId\"));\n\t\t\tp.setInt(1, postId);\n\t\t\tp.setInt(2, topicId);\n\t\t\tp.executeUpdate();\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(p);\n\t\t}\n\t}\n\n\t/**\n\t * @see net.jforum.dao.TopicDAO#getMinPostId(int)\n\t */\n\tpublic int getMinPostId(int topicId)\n\t{\n\t\tint id = -1;\n\n\t\tPreparedStatement p = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection()\n\t\t\t\t\t.prepareStatement(SystemGlobals.getSql(\"TopicModel.getMinPostId\"));\n\t\t\tp.setInt(1, topicId);\n\n\t\t\tResultSet rs = p.executeQuery();\n\t\t\tif (rs.next()) {\n\t\t\t\tid = rs.getInt(\"post_id\");\n\t\t\t}\n\n\t\t\treturn id;\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(p);\n\t\t}\n\t}\n\n\t/**\n\t * @see net.jforum.dao.TopicDAO#setModerationStatus(int, boolean)\n\t */\n\tpublic void setModerationStatus(int forumId, boolean status)\n\t{\n\t\tPreparedStatement p = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(\n\t\t\t\t\tSystemGlobals.getSql(\"TopicModel.setModerationStatus\"));\n\t\t\tp.setInt(1, status ? 1 : 0);\n\t\t\tp.setInt(2, forumId);\n\t\t\tp.executeUpdate();\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(p);\n\t\t}\n\t}\n\n\t/**\n\t * @see net.jforum.dao.TopicDAO#setModerationStatusByTopic(int, boolean)\n\t */\n\tpublic void setModerationStatusByTopic(int topicId, boolean status)\n\t{\n\t\tPreparedStatement p = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(\n\t\t\t\t\tSystemGlobals.getSql(\"TopicModel.setModerationStatusByTopic\"));\n\t\t\tp.setInt(1, status ? 1 : 0);\n\t\t\tp.setInt(2, topicId);\n\t\t\tp.executeUpdate();\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(p);\n\t\t}\n\t}\n\n\t/**\n\t * @see net.jforum.dao.TopicDAO#selectTopicTitlesByIds(java.util.Collection)\n\t */\n\tpublic List selectTopicTitlesByIds(Collection idList)\n\t{\n\t\tList l = new ArrayList();\n\t\tString sql = SystemGlobals.getSql(\"TopicModel.selectTopicTitlesByIds\");\n\n\t\tStringBuffer sb = new StringBuffer(idList.size() * 2);\n\t\tfor (Iterator iter = idList.iterator(); iter.hasNext();) {\n\t\t\tsb.append(iter.next()).append(\",\");\n\t\t}\n\n\t\tint len = sb.length();\n\t\tsql = sql.replaceAll(\":ids:\", len > 0 ? sb.toString().substring(0, len - 1) : \"0\");\n\t\tPreparedStatement p = null;\n\t\tResultSet rs = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(sql);\n\n\t\t\trs = p.executeQuery();\n\t\t\twhile (rs.next()) {\n\t\t\t\tMap m = new HashMap();\n\t\t\t\tm.put(\"id\", new Integer(rs.getInt(\"topic_id\")));\n\t\t\t\tm.put(\"title\", rs.getString(\"topic_title\"));\n\n\t\t\t\tl.add(m);\n\t\t\t}\n\t\t\treturn l;\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(rs, p);\n\t\t}\n\t}\n\n\t/**\n\t * @see net.jforum.model.UserModel#topicPosters(int)\n\t */\n\tpublic Map topicPosters(int topicId)\n\t{\n\t\tMap m = new HashMap();\n\t\t\n\t\tPreparedStatement p = null;\n\t\tResultSet rs = null;\n\n\t\ttry {\n\t\t\tStringBuffer sql = new StringBuffer(SystemGlobals.getSql(\"TopicModel.topicPosters\"));\n\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(\n\t\t\t\tSystemGlobals.getSql(\"TopicModel.distinctPosters\"));\n\t\t\tp.setInt(1, topicId);\n\n\t\t\trs = p.executeQuery();\n\n\t\t\tStringBuffer sb = new StringBuffer();\n\n\t\t\twhile (rs.next()) {\n\t\t\t\tsb.append(rs.getInt(\"user_id\")).append(',');\n\t\t\t}\n\n\t\t\trs.close();\n\t\t\tp.close();\n\n\t\t\tint index = sql.indexOf(\":ids:\");\n\t\t\tif (index > -1) {\n\t\t\t\tsql.replace(index, index + 5, sb.substring(0, sb.length() - 1));\n\t\t\t}\n\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(sql.toString());\n\t\t\trs = p.executeQuery();\n\n\t\t\twhile (rs.next()) {\n\t\t\t\tUser u = new User();\n\n\t\t\t\tu.setId(rs.getInt(\"user_id\"));\n\t\t\t\tu.setUsername(rs.getString(\"username\"));\n\t\t\t\tu.setKarma(new KarmaStatus(u.getId(), rs.getDouble(\"user_karma\")));\n\t\t\t\tu.setAvatar(rs.getString(\"user_avatar\"));\n\t\t\t\tu.setAvatarEnabled(rs.getInt(\"user_allowavatar\") == 1);\n\t\t\t\tu.setRegistrationDate(new Date(rs.getTimestamp(\"user_regdate\").getTime()));\n\t\t\t\tu.setTotalPosts(rs.getInt(\"user_posts\"));\n\t\t\t\tu.setFrom(rs.getString(\"user_from\"));\n\t\t\t\tu.setEmail(rs.getString(\"user_email\"));\n\t\t\t\tu.setRankId(rs.getInt(\"rank_id\"));\n\t\t\t\tu.setViewEmailEnabled(rs.getInt(\"user_viewemail\") == 1);\n\t\t\t\tu.setIcq(rs.getString(\"user_icq\"));\n\t\t\t\tu.setAttachSignatureEnabled(rs.getInt(\"user_attachsig\") == 1);\n\t\t\t\tu.setMsnm(rs.getString(\"user_msnm\"));\n\t\t\t\tu.setYim(rs.getString(\"user_yim\"));\n\t\t\t\tu.setWebSite(rs.getString(\"user_website\"));\n\t\t\t\tu.setAim(rs.getString(\"user_aim\"));\n\t\t\t\tu.setSignature(rs.getString(\"user_sig\"));\n\n\t\t\t\tm.put(new Integer(u.getId()), u);\n\t\t\t}\n\t\t\t\n\t\t\treturn m;\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(rs, p);\n\t\t}\n\t}\n}",
  "metadata": {
    "fileId": "GenericTopicDAO_java_chunk_4",
    "fileName": "GenericTopicDAO.java",
    "filePath": "src/net/jforum/dao/generic/GenericTopicDAO.java"
  }
}