{
  "pageContent": "File Path: src/net/jforum/dao/generic/AutoKeys.java\n\n Original Content: /*\n * Copyright (c) JForum Team\n * All rights reserved.\n\n * Redistribution and use in source and binary forms,\n * with or without modification, are permitted provided\n * that the following conditions are met:\n\n * 1) Redistributions of source code must retain the above\n * copyright notice, this list of conditions and the\n * following  disclaimer.\n * 2)  Redistributions in binary form must reproduce the\n * above copyright notice, this list of conditions and\n * the following disclaimer in the documentation and/or\n * other materials provided with the distribution.\n * 3) Neither the name of \"Rafael Steil\" nor\n * the names of its contributors may be used to endorse\n * or promote products derived from this software without\n * specific prior written permission.\n *\n * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT\n * HOLDERS AND CONTRIBUTORS \"AS IS\" AND ANY\n * EXPRESS OR IMPLIED WARRANTIES, INCLUDING,\n * BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF\n * MERCHANTABILITY AND FITNESS FOR A PARTICULAR\n * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL\n * THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE\n * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,\n * EXEMPLARY, OR CONSEQUENTIAL DAMAGES\n * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF\n * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA,\n * OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER\n * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER\n * IN CONTRACT, STRICT LIABILITY, OR TORT\n * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN\n * ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF\n * ADVISED OF THE POSSIBILITY OF SUCH DAMAGE\n *\n * Created on 24/05/2004 17:40:25\n * The JForum Project\n * http://www.jforum.net\n */\npackage net.jforum.dao.generic;\n\nimport java.sql.Connection;\nimport java.sql.PreparedStatement;\nimport java.sql.ResultSet;\nimport java.sql.SQLException;\nimport java.sql.Statement;\n\nimport net.jforum.JForumExecutionContext;\nimport net.jforum.util.DbUtils;\nimport net.jforum.util.preferences.ConfigKeys;\nimport net.jforum.util.preferences.SystemGlobals;\n\n/**\n * @author Rafael Steil\n * @version $Id: AutoKeys.java,v 1.11 2007/10/01 14:26:43 rafaelsteil Exp $\n */\npublic class AutoKeys\n{\n\tprivate String autoGeneratedKeysQuery;\n\n\tprotected boolean supportAutoGeneratedKeys()\n\t{\n\t\treturn SystemGlobals.getBoolValue(ConfigKeys.DATABASE_AUTO_KEYS);\n\t}\n\n\t/**\n\t * {@link #setSupportAutoGeneratedKey(boolean)} is set to <code>false</code>\n\t * \n\t * @param query The query to execute to retreive the last generated key\n\t */\n\tprotected void setAutoGeneratedKeysQuery(String query)\n\t{\n\t\tthis.autoGeneratedKeysQuery = query;\n\t}\n\n\tprotected String getAutoGeneratedKeysQuery()\n\t{\n\t\treturn this.autoGeneratedKeysQuery;\n\t}\n\n\tprotected String getErrorMessage()\n\t{\n\t\treturn \"Could not obtain the latest generated key. This error may be associated\"\n\t\t\t+ \" to some invalid database driver operation or server failure.\"\n\t\t\t+ \" Please check the database configurations and code logic.\";\n\t}\n\n\tprotected PreparedStatement getStatementForAutoKeys(String queryName, Connection conn) throws SQLException\n\t{\n\t\tPreparedStatement p = null;\n\t\t\n\t\tif (this.supportAutoGeneratedKeys()) {\n\t\t\tp = conn.prepareStatement(SystemGlobals.getSql(queryName), Statement.RETURN_GENERATED_KEYS);\n\t\t}\n\t\telse {\n\t\t\tp = conn.prepareStatement(SystemGlobals.getSql(queryName));\n\t\t}\n\n\t\treturn p;\n\t}\n\n\tprotected PreparedStatement getStatementForAutoKeys(String queryName) throws SQLException\n\t{\n\t\treturn this.getStatementForAutoKeys(queryName, JForumExecutionContext.getConnection());\n\t}\n\n\tprotected int executeAutoKeysQuery(PreparedStatement p) throws SQLException\n\t{\n\t\treturn this.executeAutoKeysQuery(p, JForumExecutionContext.getConnection());\n\t}\n\n\tprotected int executeAutoKeysQuery(PreparedStatement p, Connection conn) throws SQLException\n\t{\n\t\tint id = -1;\n\t\tp.executeUpdate();\n\n\t\tResultSet rs = null;\n\t\t\n\t\ttry {\n\t\t\tif (this.supportAutoGeneratedKeys()) {\n\t\t\t\trs = p.getGeneratedKeys();\n\t\t\t\t\n\t\t\t\tif (rs.next()) {\n\t\t\t\t\tid = rs.getInt(1);\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\tp = conn.prepareStatement(this.getAutoGeneratedKeysQuery());\n\t\t\t\trs = p.executeQuery();\n\n\t\t\t\tif (rs.next()) {\n\t\t\t\t\tid = rs.getInt(1);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(rs);\n\t\t}\n\n\t\tif (id == -1) {\n\t\t\tthrow new SQLException(this.getErrorMessage());\n\t\t}\n\n\t\treturn id;\n\t}\n}",
  "metadata": {
    "fileId": "AutoKeys_java_chunk_1",
    "fileName": "AutoKeys.java",
    "filePath": "src/net/jforum/dao/generic/AutoKeys.java"
  }
}