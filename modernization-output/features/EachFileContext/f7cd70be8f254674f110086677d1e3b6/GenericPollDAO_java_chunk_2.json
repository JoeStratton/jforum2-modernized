{
  "pageContent": "File Path: src/net/jforum/dao/generic/GenericPollDAO.java\n\n Original Content: public class GenericPollDAO extends AutoKeys implements PollDAO\n{\n\t/**\n\t * @see net.jforum.dao.PollDAO#addNew(net.jforum.entities.Poll)\n\t */\n\tpublic int addNew(Poll poll)\n\t{\n\t\tthis.addNewPoll(poll);\n\t\tthis.addNewPollOptions(poll.getId(), poll.getOptions());\n\n\t\treturn poll.getId();\n\t}\n\n\tprotected void addNewPoll(Poll poll)\n\t{\n\t\tPreparedStatement p = null;\n\t\ttry {\n\t\t\tp = this.getStatementForAutoKeys(\"PollModel.addNewPoll\");\n\t\t\tp.setInt(1, poll.getTopicId());\n\t\t\tp.setString(2, poll.getLabel());\n\t\t\tp.setInt(3, poll.getLength());\n\n\t\t\tthis.setAutoGeneratedKeysQuery(SystemGlobals.getSql(\"PollModel.lastGeneratedPollId\"));\n\t\t\tint pollId = this.executeAutoKeysQuery(p);\n\t\t\tpoll.setId(pollId);\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(p);\n\t\t}\n\t}\n\n\tprotected void addNewPollOptions(int pollId, List options)\n\t{\n\t\tConnection connection = JForumExecutionContext.getConnection();\n\n\t\tPreparedStatement p = null;\n\t\tResultSet rs = null;\n\t\ttry {\n\t\t\tp = connection.prepareStatement(SystemGlobals.getSql(\"PollModel.selectMaxVoteId\"));\n\n\t\t\tp.setInt(1, pollId);\n\t\t\trs = p.executeQuery();\n\t\t\trs.next();\n\n\t\t\tint optionId = rs.getInt(1);\n\n\t\t\trs.close();\n\t\t\trs = null;\n\t\t\tp.close();\n\t\t\tp = null;\n\n\t\t\tp = connection.prepareStatement(SystemGlobals.getSql(\"PollModel.addNewPollOption\"));\n\t\t\tfor (Iterator iter = options.iterator(); iter.hasNext();) {\n\t\t\t\tPollOption option = (PollOption) iter.next();\n\n\t\t\t\tp.setInt(1, pollId);\n\t\t\t\tp.setInt(2, ++optionId);\n\t\t\t\tp.setString(3, option.getText());\n\n\t\t\t\tp.executeUpdate();\n\t\t\t}\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(rs, p);\n\t\t}\n\t}\n\n\t/**\n\t * @see net.jforum.dao.PollDAO#selectById(int)\n\t */\n\tpublic Poll selectById(int pollId)\n\t{\n\t\tPreparedStatement p = null;\n\t\tPreparedStatement o = null;\n\t\tResultSet ors = null;\n\t\tResultSet prs = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(SystemGlobals.getSql(\"PollModel.selectById\"));\n\t\t\tp.setInt(1, pollId);\n\t\t\tprs = p.executeQuery();\n\n\t\t\tPoll poll = null;\n\t\t\tif (prs.next()) {\n\t\t\t\tpoll = this.makePoll(prs);\n\n\t\t\t\to = JForumExecutionContext.getConnection().prepareStatement(\n\t\t\t\t\t\tSystemGlobals.getSql(\"PollModel.selectOptionsByPollId\"));\n\t\t\t\to.setInt(1, pollId);\n\t\t\t\tors = o.executeQuery();\n\n\t\t\t\twhile (ors.next()) {\n\t\t\t\t\tpoll.addOption(this.makePollOption(ors));\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn poll;\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(prs, p);\n\t\t\tDbUtils.close(ors, o);\n\t\t}\n\t}\n\n\tprotected Poll makePoll(ResultSet rs) throws SQLException\n\t{\n\t\tPoll poll = new Poll();\n\t\tpoll.setId(rs.getInt(\"vote_id\"));\n\t\tpoll.setTopicId(rs.getInt(\"topic_id\"));\n\t\tpoll.setLabel(rs.getString(\"vote_text\"));\n\t\tpoll.setStartTime(new Date(rs.getTimestamp(\"vote_start\").getTime()));\n\t\tpoll.setLength(rs.getInt(\"vote_length\"));\n\n\t\treturn poll;\n\t}\n\n\tprotected PollOption makePollOption(ResultSet rs) throws SQLException\n\t{\n\t\tPollOption option = new PollOption();\n\t\toption.setPollId(rs.getInt(\"vote_id\"));\n\t\toption.setId(rs.getInt(\"vote_option_id\"));\n\t\toption.setText(rs.getString(\"vote_option_text\"));\n\t\toption.setVoteCount(rs.getInt(\"vote_result\"));\n\n\t\treturn option;\n\t}\n\n\t/**\n\t * @see net.jforum.dao.PollDAO#voteOnPoll(int, int, int, java.lang.String)\n\t */\n\tpublic void voteOnPoll(int pollId, int optionId, int userId, String ipAddress)\n\t{\n\t\tConnection connection = JForumExecutionContext.getConnection();\n\n\t\tPreparedStatement v = null;\n\t\tPreparedStatement p = null;\n\t\ttry {\n\t\t\tp = connection.prepareStatement(SystemGlobals.getSql(\"PollModel.incrementVoteCount\"));\n\t\t\tv = connection.prepareStatement(SystemGlobals.getSql(\"PollModel.addNewVoter\"));\n\n\t\t\tp.setInt(1, pollId);\n\t\t\tp.setInt(2, optionId);\n\n\t\t\tv.setInt(1, pollId);\n\t\t\tv.setInt(2, userId);\n\t\t\tv.setString(3, ipAddress);\n\n\t\t\tp.executeUpdate();\n\t\t\tv.executeUpdate();\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(p);\n\t\t\tDbUtils.close(v);\n\t\t}\n\t}\n\n\t/**\n\t * @see net.jforum.dao.PollDAO#hasVotedOnPoll(int, int)\n\t */\n\tpublic boolean hasUserVotedOnPoll(int pollId, int userId)\n\t{\n\t\tPreparedStatement p = null;\n\t\tResultSet rs = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(SystemGlobals.getSql(\"PollModel.selectVoter\"));\n\t\t\tp.setInt(1, pollId);\n\t\t\tp.setInt(2, userId);\n\n\t\t\trs = p.executeQuery();\n\n\t\t\treturn rs.next();\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(rs, p);\n\t\t}\n\t}\n\n\t/**\n\t * Tells if the anonymous user has already voted on the given poll from the given IP\n\t * \n\t * @param pollId\n\t *            the poll id that is being checked\n\t * @param ipAddress\n\t *            the IP address of the anonymoususer to check the vote for\n\t * @return true if the user has already voted on the given poll\n\t */\n\tpublic boolean hasUserVotedOnPoll(int pollId, String ipAddress)\n\t{\n\t\tPreparedStatement p = null;\n\t\tResultSet rs = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(\n\t\t\t\t\tSystemGlobals.getSql(\"PollModel.selectVoterByIP\"));\n\t\t\tp.setInt(1, pollId);\n\t\t\tp.setString(2, ipAddress);\n\n\t\t\trs = p.executeQuery();\n\n\t\t\treturn rs.next();\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(rs, p);\n\t\t}\n\t}\n\n\t/**\n\t * @see net.jforum.dao.PollDAO#delete(int)\n\t */\n\tpublic void deleteByTopicId(int topicId)\n\t{\n\t\t// first, lookup the poll id, then delete it\n\t\tPreparedStatement p = null;\n\t\tResultSet rs = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(\n\t\t\t\t\tSystemGlobals.getSql(\"PollModel.selectPollByTopicId\"));\n\n\t\t\tp.setInt(1, topicId);\n\n\t\t\trs = p.executeQuery();\n\n\t\t\tint pollId = 0;\n\t\t\tif (rs.next()) {\n\t\t\t\tpollId = rs.getInt(\"vote_id\");\n\t\t\t}\n\n\t\t\tif (pollId != 0) {\n\t\t\t\tdelete(pollId);\n\t\t\t}\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(rs, p);\n\t\t}\n\t}\n\n\t/**\n\t * @see net.jforum.dao.PollDAO#delete(int)\n\t */\n\tpublic void delete(int pollId)\n\t{\n\t\tthis.deletePollVotes(pollId);\n\t\tthis.deleteAllPollOptions(pollId);\n\t\tthis.deletePoll(pollId);\n\t}\n\n\tprotected void deletePoll(int pollId)\n\t{\n\t\tPreparedStatement poll = null;\n\t\ttry {\n\t\t\tpoll = JForumExecutionContext.getConnection()\n\t\t\t\t\t.prepareStatement(SystemGlobals.getSql(\"PollModel.deletePoll\"));\n\t\t\tpoll.setInt(1, pollId);\n\t\t\tpoll.executeUpdate();\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(poll);\n\t\t}\n\t}\n\n\tprotected void deletePollVotes(int pollId)\n\t{\n\t\tPreparedStatement poll = null;\n\t\ttry {\n\t\t\tpoll = JForumExecutionContext.getConnection().prepareStatement(\n\t\t\t\t\tSystemGlobals.getSql(\"PollModel.deletePollVoters\"));\n\t\t\tpoll.setInt(1, pollId);\n\t\t\tpoll.executeUpdate();\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(poll);\n\t\t}\n\t}\n\n\tprotected void deleteAllPollOptions(int pollId)\n\t{\n\t\tPreparedStatement poll = null;\n\t\ttry {\n\t\t\tpoll = JForumExecutionContext.getConnection().prepareStatement(\n\t\t\t\t\tSystemGlobals.getSql(\"PollModel.deleteAllPollOptions\"));\n\n\t\t\tpoll.setInt(1, pollId);\n\t\t\tpoll.executeUpdate();\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(poll);\n\t\t}\n\t}\n\n\tprotected void deletePollOptions(int pollId, List deleted) throws SQLException\n\t{\n\t\tConnection connection = JForumExecutionContext.getConnection();\n\n\t\tPreparedStatement options = null;\n\t\ttry {\n\t\t\toptions = connection.prepareStatement(SystemGlobals.getSql(\"PollModel.deletePollOption\"));\n\n\t\t\tfor (Iterator iter = deleted.iterator(); iter.hasNext();) {\n\t\t\t\tPollOption o = (PollOption) iter.next();\n\n\t\t\t\t// Option\n\t\t\t\toptions.setInt(1, pollId);\n\t\t\t\toptions.setInt(2, o.getId());\n\t\t\t\toptions.executeUpdate();\n\t\t\t}\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(options);\n\t\t}\n\t}\n\n\tprotected void updatePollOptions(int pollId, List options) throws SQLException\n\t{\n\t\tPreparedStatement p = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(\n\t\t\t\t\tSystemGlobals.getSql(\"PollModel.updatePollOption\"));\n\n\t\t\tfor (Iterator iter = options.iterator(); iter.hasNext();) {\n\t\t\t\tPollOption o = (PollOption) iter.next();\n\n\t\t\t\tp.setString(1, o.getText());\n\t\t\t\tp.setInt(2, o.getId());\n\t\t\t\tp.setInt(3, pollId);\n\n\t\t\t\tp.executeUpdate();\n\t\t\t}\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(p);\n\t\t}\n\t}\n\n\t/**\n\t * @see net.jforum.dao.PollDAO#update(net.jforum.entities.Poll)\n\t */\n\tpublic void update(Poll poll)\n\t{\n\t\ttry {\n\t\t\tthis.updatePoll(poll);\n\n\t\t\tif (poll.getChanges() != null) {\n\t\t\t\tthis.deletePollOptions(poll.getId(), poll.getChanges().getDeletedOptions());\n\t\t\t\tthis.updatePollOptions(poll.getId(), poll.getChanges().getChangedOptions());\n\t\t\t\tthis.addNewPollOptions(poll.getId(), poll.getChanges().getNewOptions());\n\t\t\t}\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t}\n\n\tprotected void updatePoll(Poll poll) throws SQLException\n\t{\n\t\tPreparedStatement p = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(SystemGlobals.getSql(\"PollModel.updatePoll\"));\n\n\t\t\tp.setString(1, poll.getLabel());\n\t\t\tp.setInt(2, poll.getLength());\n\t\t\tp.setInt(3, poll.getId());\n\n\t\t\tp.executeUpdate();\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(p);\n\t\t}\n\t}\n}",
  "metadata": {
    "fileId": "GenericPollDAO_java_chunk_2",
    "fileName": "GenericPollDAO.java",
    "filePath": "src/net/jforum/dao/generic/GenericPollDAO.java"
  }
}