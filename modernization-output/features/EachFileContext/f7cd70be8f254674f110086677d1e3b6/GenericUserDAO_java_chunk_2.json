{
  "pageContent": "File Path: src/net/jforum/dao/generic/GenericUserDAO.java\n\n Original Content: public class GenericUserDAO extends AutoKeys implements UserDAO\n{\n\tprivate static LoginAuthenticator loginAuthenticator;\n\n\tpublic GenericUserDAO()\n\t{\n\t\tloginAuthenticator = (LoginAuthenticator)SystemGlobals.getObjectValue(\n\t\t\tConfigKeys.LOGIN_AUTHENTICATOR_INSTANCE);\n\t\t\n\t\tif (loginAuthenticator == null) {\n\t\t\tthrow new ForumException(\"There is no login.authenticator configured. Check your login.authenticator configuration key.\");\n\t\t}\n\t\t\n\t\tloginAuthenticator.setUserModel(this);\n\t}\n\t\n\t/**\n\t * @see net.jforum.dao.UserDAO#pendingActivations()\n\t */\n\tpublic List pendingActivations() \n\t{\n\t\tPreparedStatement p = null;\n\t\tResultSet rs = null;\n\t\t\n\t\tList l = new ArrayList();\n\t\t\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(\n\t\t\t\tSystemGlobals.getSql(\"UserModel.pendingActivations\"));\n\n\t\t\trs = p.executeQuery();\n\n\t\t\twhile (rs.next()) {\n\t\t\t\tUser user = new User();\n\t\t\t\t\n\t\t\t\tuser.setId(rs.getInt(\"user_id\"));\n\t\t\t\tuser.setUsername(rs.getString(\"username\"));\n\t\t\t\tuser.setRegistrationDate(new Date(rs.getTimestamp(\"user_regdate\").getTime()));\n\t\t\t\t\n\t\t\t\tl.add(user);\n\t\t\t}\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(rs, p);\n\t\t}\n\t\t\n\t\treturn l;\n\t}\n\n\t/**\n\t * @see net.jforum.dao.UserDAO#selectById(int)\n\t */\n\tpublic User selectById(int userId)\n\t{\n\t\tString q = SystemGlobals.getSql(\"UserModel.selectById\");\n\t\tPreparedStatement p = null;\n\t\tResultSet rs = null;\n\t\t\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(q);\n\t\t\tp.setInt(1, userId);\n\n\t\t\trs = p.executeQuery();\n\t\t\tUser u = new User();\n\n\t\t\tif (rs.next()) {\n\t\t\t\tthis.fillUserFromResultSet(u, rs);\n\t\t\t\tu.setPrivateMessagesCount(rs.getInt(\"private_messages\"));\n\n\t\t\t\trs.close();\n\t\t\t\tp.close();\n\n\t\t\t\t// User groups\n\t\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(\n\t\t\t\t\t\tSystemGlobals.getSql(\"UserModel.selectGroups\"));\n\t\t\t\tp.setInt(1, userId);\n\n\t\t\t\trs = p.executeQuery();\n\t\t\t\twhile (rs.next()) {\n\t\t\t\t\tGroup g = new Group();\n\t\t\t\t\tg.setName(rs.getString(\"group_name\"));\n\t\t\t\t\tg.setId(rs.getInt(\"group_id\"));\n\n\t\t\t\t\tu.getGroupsList().add(g);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn u;\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(rs, p);\n\t\t}\n\t}\n\n\tpublic User selectByName(String username)\n\t{\n\t\tPreparedStatement p = null;\n\t\tResultSet rs = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(SystemGlobals.getSql(\"UserModel.selectByName\"));\n\t\t\tp.setString(1, username);\n\n\t\t\trs = p.executeQuery();\n\t\t\tUser u = null;\n\n\t\t\tif (rs.next()) {\n\t\t\t\tu = new User();\n\t\t\t\tthis.fillUserFromResultSet(u, rs);\n\t\t\t}\n\n\t\t\treturn u;\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(rs, p);\n\t\t}\n\t}\n\n\tprotected void fillUserFromResultSet(User u, ResultSet rs) throws SQLException\n\t{\n\t\tu.setAim(rs.getString(\"user_aim\"));\n\t\tu.setAvatar(rs.getString(\"user_avatar\"));\n\t\tu.setGender(rs.getString(\"gender\"));\n\t\tu.setRankId(rs.getInt(\"rank_id\"));\n\t\tu.setThemeId(rs.getInt(\"themes_id\"));\n\t\tu.setPrivateMessagesEnabled(rs.getInt(\"user_allow_pm\") == 1);\n\t\tu.setNotifyOnMessagesEnabled(rs.getInt(\"user_notify\") == 1);\n\t\tu.setViewOnlineEnabled(rs.getInt(\"user_viewonline\") == 1);\n\t\tu.setPassword(rs.getString(\"user_password\"));\n\t\tu.setViewEmailEnabled(rs.getInt(\"user_viewemail\") == 1);\n\t\tu.setViewOnlineEnabled(rs.getInt(\"user_viewonline\") == 1);\n\t\tu.setAvatarEnabled(rs.getInt(\"user_allowavatar\") == 1);\n\t\tu.setBbCodeEnabled(rs.getInt(\"user_allowbbcode\") == 1);\n\t\tu.setHtmlEnabled(rs.getInt(\"user_allowhtml\") == 1);\n\t\tu.setSmiliesEnabled(rs.getInt(\"user_allowsmilies\") == 1);\n\t\tu.setEmail(rs.getString(\"user_email\"));\n\t\tu.setFrom(rs.getString(\"user_from\"));\n\t\tu.setIcq(rs.getString(\"user_icq\"));\n\t\tu.setId(rs.getInt(\"user_id\"));\n\t\tu.setInterests(rs.getString(\"user_interests\"));\n\t\tu.setBiography(rs.getString(\"user_biography\"));\n\t\tu.setLastVisit(rs.getTimestamp(\"user_lastvisit\"));\n\t\tu.setOccupation(rs.getString(\"user_occ\"));\n\t\tu.setTotalPosts(rs.getInt(\"user_posts\"));\n\t\tu.setRegistrationDate(new Date(rs.getTimestamp(\"user_regdate\").getTime()));\n\t\tu.setSignature(rs.getString(\"user_sig\"));\n\t\tu.setWebSite(rs.getString(\"user_website\"));\n\t\tu.setYim(rs.getString(\"user_yim\"));\n\t\tu.setUsername(rs.getString(\"username\"));\n\t\tu.setAttachSignatureEnabled(rs.getInt(\"user_attachsig\") == 1);\n\t\tu.setMsnm(rs.getString(\"user_msnm\"));\n\t\tu.setLang(rs.getString(\"user_lang\"));\n\t\tu.setActive(rs.getInt(\"user_active\"));\n\t\tu.setKarma(new KarmaStatus(u.getId(), rs.getDouble(\"user_karma\")));\n\t\tu.setNotifyPrivateMessagesEnabled(rs.getInt(\"user_notify_pm\") == 1);\n\t\tu.setDeleted(rs.getInt(\"deleted\"));\n\t\tu.setNotifyAlways(rs.getInt(\"user_notify_always\") == 1);\n\t\tu.setNotifyText(rs.getInt(\"user_notify_text\") == 1);\n\n\t\tString actkey = rs.getString(\"user_actkey\");\n\t\tu.setActivationKey(actkey == null || \"\".equals(actkey) ? null : actkey);\n\t}\n\n\t/**\n\t * @see net.jforum.dao.UserDAO#delete(int)\n\t */\n\tpublic void delete(int userId)\n\t{\n\t\tPreparedStatement p = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection()\n\t\t\t\t\t.prepareStatement(SystemGlobals.getSql(\"UserModel.deletedStatus\"));\n\t\t\tp.setInt(1, 1);\n\t\t\tp.setInt(2, userId);\n\n\t\t\tp.executeUpdate();\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(p);\n\t\t}\n\t}\n\n\t/**\n\t * @see net.jforum.dao.UserDAO#update(net.jforum.entities.User)\n\t */\n\tpublic void update(User user)\n\t{\n\t\tPreparedStatement p = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(SystemGlobals.getSql(\"UserModel.update\"));\n\n\t\t\tp.setString(1, user.getAim());\n\t\t\tp.setString(2, user.getAvatar());\n\t\t\tp.setString(3, user.getGender());\n\t\t\tp.setInt(4, user.getThemeId());\n\t\t\tp.setInt(5, user.isPrivateMessagesEnabled() ? 1 : 0);\n\t\t\tp.setInt(6, user.isAvatarEnabled() ? 1 : 0);\n\t\t\tp.setInt(7, user.isBbCodeEnabled() ? 1 : 0);\n\t\t\tp.setInt(8, user.isHtmlEnabled() ? 1 : 0);\n\t\t\tp.setInt(9, user.isSmiliesEnabled() ? 1 : 0);\n\t\t\tp.setString(10, user.getEmail());\n\t\t\tp.setString(11, user.getFrom());\n\t\t\tp.setString(12, user.getIcq());\n\t\t\tp.setString(13, user.getInterests());\n\t\t\tp.setString(14, user.getOccupation());\n\t\t\tp.setString(15, user.getSignature());\n\t\t\tp.setString(16, user.getWebSite());\n\t\t\tp.setString(17, user.getYim());\n\t\t\tp.setString(18, user.getMsnm());\n\t\t\tp.setString(19, user.getPassword());\n\t\t\tp.setInt(20, user.isViewEmailEnabled() ? 1 : 0);\n\t\t\tp.setInt(21, user.isViewOnlineEnabled() ? 1 : 0);\n\t\t\tp.setInt(22, user.isNotifyOnMessagesEnabled() ? 1 : 0);\n\t\t\tp.setInt(23, user.getAttachSignatureEnabled() ? 1 : 0);\n\t\t\tp.setString(24, user.getUsername());\n\t\t\tp.setString(25, user.getLang());\n\t\t\tp.setInt(26, user.isNotifyPrivateMessagesEnabled() ? 1 : 0);\n\t\t\tp.setString(27, user.getBiography());\n\n\t\t\tif (user.getLastVisit() == null) {\n\t\t\t\tuser.setLastVisit(new Date());\n\t\t\t}\n\n\t\t\tp.setTimestamp(28, new Timestamp(user.getLastVisit().getTime()));\n\t\t\tp.setInt(29, user.notifyAlways() ? 1 : 0);\n\t\t\tp.setInt(30, user.notifyText() ? 1 : 0);\n\t\t\tp.setInt(31, user.getRankId());\n\t\t\tp.setInt(32, user.getId());\n\n\t\t\tp.executeUpdate();\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(p);\n\t\t}\n\t}\n\n\t/**\n\t * @see net.jforum.dao.UserDAO#addNew(net.jforum.entities.User)\n\t */\n\tpublic int addNew(User user)\n\t{\n\t\tPreparedStatement p = null;\n\t\ttry {\n\t\t\tp = this.getStatementForAutoKeys(\"UserModel.addNew\");\n\n\t\t\tthis.initNewUser(user, p);\n\n\t\t\tthis.setAutoGeneratedKeysQuery(SystemGlobals.getSql(\"UserModel.lastGeneratedUserId\"));\n\t\t\tint id = this.executeAutoKeysQuery(p);\n\n\t\t\tthis.addToGroup(id, new int[] { SystemGlobals.getIntValue(ConfigKeys.DEFAULT_USER_GROUP) });\n\n\t\t\tuser.setId(id);\n\t\t\treturn id;\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(p);\n\t\t}\n\t}\n\n\tprotected void initNewUser(User user, PreparedStatement p) throws SQLException\n\t{\n\t\tp.setString(1, user.getUsername());\n\t\tp.setString(2, user.getPassword());\n\t\tp.setString(3, user.getEmail());\n\t\tp.setTimestamp(4, new Timestamp(System.currentTimeMillis()));\n\t\tp.setString(5, user.getActivationKey());\n\t}\n\n\t/**\n\t * @see net.jforum.dao.UserDAO#addNewWithId(net.jforum.entities.User)\n\t */\n\tpublic void addNewWithId(User user)\n\t{\n\t\tPreparedStatement p = null;\n\t\ttry {\n\t\t\tp = this.getStatementForAutoKeys(\"UserModel.addNewWithId\");\n\n\t\t\tthis.initNewUser(user, p);\n\t\t\tp.setInt(6, user.getId());\n\n\t\t\tp.executeUpdate();\n\n\t\t\tthis.addToGroup(user.getId(), new int[] { SystemGlobals.getIntValue(ConfigKeys.DEFAULT_USER_GROUP) });\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(p);\n\t\t}\n\t}\n\n\t/**\n\t * @see net.jforum.dao.UserDAO#decrementPosts(int)\n\t */\n\tpublic void decrementPosts(int userId)\n\t{\n\t\tPreparedStatement p = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(\n\t\t\t\t\tSystemGlobals.getSql(\"UserModel.decrementPosts\"));\n\t\t\tp.setInt(1, userId);\n\n\t\t\tp.executeUpdate();\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(p);\n\t\t}\n\t}\n\n\t/**\n\t * @see net.jforum.dao.UserDAO#incrementPosts(int)\n\t */\n\tpublic void incrementPosts(int userId)\n\t{\n\t\tPreparedStatement p = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(\n\t\t\t\t\tSystemGlobals.getSql(\"UserModel.incrementPosts\"));\n\t\t\tp.setInt(1, userId);\n\n\t\t\tp.executeUpdate();\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(p);\n\t\t}\n\t}\n\n\t/**\n\t * @see net.jforum.dao.UserDAO#incrementRanking(int)\n\t */\n\tpublic void setRanking(int userId, int rankingId)\n\t{\n\t\tPreparedStatement p = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(SystemGlobals.getSql(\"UserModel.rankingId\"));\n\t\t\tp.setInt(1, rankingId);\n\t\t\tp.setInt(2, userId);\n\n\t\t\tp.executeUpdate();\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(p);\n\t\t}\n\t}",
  "metadata": {
    "fileId": "GenericUserDAO_java_chunk_2",
    "fileName": "GenericUserDAO.java",
    "filePath": "src/net/jforum/dao/generic/GenericUserDAO.java"
  }
}