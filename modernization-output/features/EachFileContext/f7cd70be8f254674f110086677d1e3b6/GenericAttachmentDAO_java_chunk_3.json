{
  "pageContent": "File Path: src/net/jforum/dao/generic/GenericAttachmentDAO.java\n\n Original Content: /**\n\t * @see net.jforum.dao.AttachmentDAO#removeExtensions(java.lang.String[])\n\t */\n\tpublic void removeExtensions(String[] ids)\n\t{\n\t\tPreparedStatement p = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(\n\t\t\t\t\tSystemGlobals.getSql(\"AttachmentModel.removeExtension\"));\n\t\t\tfor (int i = 0; i < ids.length; i++) {\n\t\t\t\tp.setInt(1, Integer.parseInt(ids[i]));\n\t\t\t\tp.executeUpdate();\n\t\t\t}\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(p);\n\t\t}\n\t}\n\n\t/**\n\t * @see net.jforum.dao.AttachmentDAO#selectExtensions()\n\t */\n\tpublic List selectExtensions()\n\t{\n\t\tList l = new ArrayList();\n\n\t\tPreparedStatement p = null;\n\t\tResultSet rs = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(\n\t\t\t\t\tSystemGlobals.getSql(\"AttachmentModel.selectExtensions\"));\n\n\t\t\trs = p.executeQuery();\n\t\t\twhile (rs.next()) {\n\t\t\t\tl.add(this.getExtension(rs));\n\t\t\t}\n\n\t\t\treturn l;\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(rs, p);\n\t\t}\n\t}\n\n\t/**\n\t * @see net.jforum.dao.AttachmentDAO#updateExtension(net.jforum.entities.AttachmentExtension)\n\t */\n\tpublic void updateExtension(AttachmentExtension extension)\n\t{\n\t\tPreparedStatement p = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(\n\t\t\t\t\tSystemGlobals.getSql(\"AttachmentModel.updateExtension\"));\n\t\t\tp.setInt(1, extension.getExtensionGroupId());\n\t\t\tp.setString(2, extension.getComment());\n\t\t\tp.setString(3, extension.getUploadIcon());\n\t\t\tp.setString(4, extension.getExtension().toLowerCase());\n\t\t\tp.setInt(5, extension.isAllow() ? 1 : 0);\n\t\t\tp.setInt(6, extension.getId());\n\t\t\tp.executeUpdate();\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(p);\n\t\t}\n\t}\n\n\t/**\n\t * @see net.jforum.dao.AttachmentDAO#selectExtension(java.lang.String)\n\t */\n\tpublic AttachmentExtension selectExtension(String extension)\n\t{\n\t\treturn this.searchExtension(SystemGlobals.getValue(ConfigKeys.EXTENSION_FIELD), extension);\n\t}\n\n\tprivate AttachmentExtension selectExtension(int extensionId)\n\t{\n\t\treturn this.searchExtension(\"extension_id\", new Integer(extensionId));\n\t}\n\n\tprivate AttachmentExtension searchExtension(String paramName, Object paramValue)\n\t{\n\t\tPreparedStatement p = null;\n\t\tResultSet rs = null;\n\t\ttry {\n\t\t\tString sql = SystemGlobals.getSql(\"AttachmentModel.selectExtension\");\n\t\t\tsql = sql.replaceAll(\"\\\\$field\", paramName);\n\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(sql);\n\t\t\tp.setObject(1, paramValue);\n\n\t\t\tAttachmentExtension e = new AttachmentExtension();\n\n\t\t\trs = p.executeQuery();\n\t\t\tif (rs.next()) {\n\t\t\t\te = this.getExtension(rs);\n\t\t\t}\n\t\t\telse {\n\t\t\t\te.setUnknown(true);\n\t\t\t}\n\n\t\t\treturn e;\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(rs, p);\n\t\t}\n\t}\n\n\tprotected AttachmentExtension getExtension(ResultSet rs) throws SQLException\n\t{\n\t\tAttachmentExtension e = new AttachmentExtension();\n\t\te.setAllow(rs.getInt(\"allow\") == 1);\n\t\te.setComment(rs.getString(\"description\"));\n\t\te.setExtension(rs.getString(\"extension\"));\n\t\te.setExtensionGroupId(rs.getInt(\"extension_group_id\"));\n\t\te.setId(rs.getInt(\"extension_id\"));\n\n\t\tString icon = rs.getString(\"upload_icon\");\n\t\tif (icon == null || icon.equals(\"\")) {\n\t\t\ticon = rs.getString(\"group_icon\");\n\t\t}\n\n\t\te.setUploadIcon(icon);\n\n\t\treturn e;\n\t}\n\n\t/**\n\t * @see net.jforum.dao.AttachmentDAO#addAttachment(net.jforum.entities.Attachment)\n\t */\n\tpublic void addAttachment(Attachment a)\n\t{\n\t\tPreparedStatement p = null;\n\t\ttry {\n\t\t\tp = this.getStatementForAutoKeys(\"AttachmentModel.addAttachment\");\n\t\t\tp.setInt(1, a.getPostId());\n\t\t\tp.setInt(2, a.getPrivmsgsId());\n\t\t\tp.setInt(3, a.getUserId());\n\n\t\t\tthis.setAutoGeneratedKeysQuery(SystemGlobals.getSql(\"AttachmentModel.lastGeneratedAttachmentId\"));\n\t\t\tint id = this.executeAutoKeysQuery(p);\n\t\t\tp.close();\n\t\t\tp = null;\n\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(\n\t\t\t\t\tSystemGlobals.getSql(\"AttachmentModel.addAttachmentInfo\"));\n\t\t\tp.setInt(1, id);\n\t\t\tp.setString(2, a.getInfo().getPhysicalFilename());\n\t\t\tp.setString(3, a.getInfo().getRealFilename());\n\t\t\tp.setString(4, a.getInfo().getComment());\n\t\t\tp.setString(5, a.getInfo().getMimetype());\n\t\t\tp.setLong(6, a.getInfo().getFilesize());\n\t\t\tp.setTimestamp(7, new Timestamp(a.getInfo().getUploadTimeInMillis()));\n\t\t\tp.setInt(8, 0);\n\t\t\tp.setInt(9, a.getInfo().getExtension().getId());\n\t\t\tp.executeUpdate();\n\n\t\t\tthis.updatePost(a.getPostId(), 1);\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(p);\n\t\t}\n\t}\n\n\tprotected void updatePost(int postId, int count)\n\t{\n\t\tPreparedStatement p = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(\n\t\t\t\t\tSystemGlobals.getSql(\"AttachmentModel.updatePost\"));\n\t\t\tp.setInt(1, count);\n\t\t\tp.setInt(2, postId);\n\t\t\tp.executeUpdate();\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(p);\n\t\t}\n\t}\n\n\t/**\n\t * @see net.jforum.dao.AttachmentDAO#removeAttachment(int, int)\n\t */\n\tpublic void removeAttachment(int id, int postId)\n\t{\n\t\tPreparedStatement p = null;\n\t\tResultSet rs = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(\n\t\t\t\t\tSystemGlobals.getSql(\"AttachmentModel.removeAttachmentInfo\"));\n\t\t\tp.setInt(1, id);\n\t\t\tp.executeUpdate();\n\t\t\tp.close();\n\t\t\tp = null;\n\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(\n\t\t\t\t\tSystemGlobals.getSql(\"AttachmentModel.removeAttachment\"));\n\t\t\tp.setInt(1, id);\n\t\t\tp.executeUpdate();\n\t\t\tp.close();\n\t\t\tp = null;\n\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(\n\t\t\t\t\tSystemGlobals.getSql(\"AttachmentModel.countPostAttachments\"));\n\t\t\tp.setInt(1, postId);\n\n\t\t\trs = p.executeQuery();\n\t\t\tif (rs.next()) {\n\t\t\t\tthis.updatePost(postId, rs.getInt(1));\n\t\t\t}\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(rs, p);\n\t\t}\n\t}\n\n\t/**\n\t * @see net.jforum.dao.AttachmentDAO#updateAttachment(net.jforum.entities.Attachment)\n\t */\n\tpublic void updateAttachment(Attachment a)\n\t{\n\t\tPreparedStatement p = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(\n\t\t\t\t\tSystemGlobals.getSql(\"AttachmentModel.updateAttachment\"));\n\t\t\tp.setString(1, a.getInfo().getComment());\n\t\t\tp.setInt(2, a.getInfo().getDownloadCount());\n\t\t\tp.setInt(3, a.getId());\n\t\t\tp.executeUpdate();\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(p);\n\t\t}\n\t}\n\n\t/**\n\t * @see net.jforum.dao.AttachmentDAO#selectAttachments(int)\n\t */\n\tpublic List selectAttachments(int postId)\n\t{\n\t\tList l = new ArrayList();\n\n\t\tPreparedStatement p = null;\n\t\tResultSet rs = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(\n\t\t\t\t\tSystemGlobals.getSql(\"AttachmentModel.selectAttachments\"));\n\t\t\tp.setInt(1, postId);\n\n\t\t\trs = p.executeQuery();\n\t\t\twhile (rs.next()) {\n\t\t\t\tl.add(this.getAttachment(rs));\n\t\t\t}\n\n\t\t\treturn l;\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(rs, p);\n\t\t}\n\t}\n\n\tprotected Attachment getAttachment(ResultSet rs) throws SQLException\n\t{\n\t\tAttachment a = new Attachment();\n\t\ta.setId(rs.getInt(\"attach_id\"));\n\t\ta.setPostId(rs.getInt(\"post_id\"));\n\t\ta.setPrivmsgsId(rs.getInt(\"privmsgs_id\"));\n\n\t\tAttachmentInfo ai = new AttachmentInfo();\n\t\tai.setComment(rs.getString(\"description\"));\n\t\tai.setDownloadCount(rs.getInt(\"download_count\"));\n\t\tai.setFilesize(rs.getLong(\"filesize\"));\n\t\tai.setMimetype(rs.getString(\"mimetype\"));\n\t\tai.setPhysicalFilename(rs.getString(\"physical_filename\"));\n\t\tai.setRealFilename(rs.getString(\"real_filename\"));\n\t\tai.setUploadTime(new Date(rs.getTimestamp(\"upload_time\").getTime()));\n\t\tai.setExtension(this.selectExtension(rs.getInt(\"extension_id\")));\n\n\t\ta.setInfo(ai);\n\n\t\treturn a;\n\t}\n\n\t/**\n\t * @see net.jforum.dao.AttachmentDAO#selectAttachmentById(int)\n\t */\n\tpublic Attachment selectAttachmentById(int attachId)\n\t{\n\t\tResultSet rs = null;\n\t\tPreparedStatement p = null;\n\t\ttry {\n\t\t\tAttachment e = null;\n\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(\n\t\t\t\t\tSystemGlobals.getSql(\"AttachmentModel.selectAttachmentById\"));\n\t\t\tp.setInt(1, attachId);\n\n\t\t\trs = p.executeQuery();\n\t\t\tif (rs.next()) {\n\t\t\t\te = this.getAttachment(rs);\n\t\t\t}\n\n\t\t\treturn e;\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(rs, p);\n\t\t}\n\t}\n\n\tpublic boolean isPhysicalDownloadMode(int extensionGroupId)\n\t{\n\t\tboolean result = true;\n\n\t\tPreparedStatement p = null;\n\t\tResultSet rs = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(\n\t\t\t\t\tSystemGlobals.getSql(\"AttachmentModel.isPhysicalDownloadMode\"));\n\n\t\t\tp.setInt(1, extensionGroupId);\n\n\t\t\trs = p.executeQuery();\n\t\t\tif (rs.next()) {\n\t\t\t\tresult = (rs.getInt(\"download_mode\") == 2);\n\t\t\t}\n\n\t\t\treturn result;\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(rs, p);\n\t\t}\n\t}\n}",
  "metadata": {
    "fileId": "GenericAttachmentDAO_java_chunk_3",
    "fileName": "GenericAttachmentDAO.java",
    "filePath": "src/net/jforum/dao/generic/GenericAttachmentDAO.java"
  }
}