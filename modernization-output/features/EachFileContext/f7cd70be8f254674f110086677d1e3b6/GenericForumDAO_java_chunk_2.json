{
  "pageContent": "File Path: src/net/jforum/dao/generic/GenericForumDAO.java\n\n Original Content: public class GenericForumDAO extends AutoKeys implements net.jforum.dao.ForumDAO\n{\n\t/**\n\t * @see net.jforum.dao.ForumDAO#selectById(int)\n\t */\n\tpublic Forum selectById(int forumId)\n\t{\n\t\tPreparedStatement p = null;\n\t\tResultSet rs = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(SystemGlobals.getSql(\"ForumModel.selectById\"));\n\t\t\tp.setInt(1, forumId);\n\n\t\t\trs = p.executeQuery();\n\n\t\t\tForum f = new Forum();\n\n\t\t\tif (rs.next()) {\n\t\t\t\tf = this.fillForum(rs);\n\t\t\t}\n\t\t\treturn f;\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(rs, p);\n\t\t}\n\t}\n\n\tprotected Forum fillForum(ResultSet rs) throws SQLException\n\t{\n\t\tForum f = new Forum();\n\n\t\tf.setId(rs.getInt(\"forum_id\"));\n\t\tf.setIdCategories(rs.getInt(\"categories_id\"));\n\t\tf.setName(rs.getString(\"forum_name\"));\n\t\tf.setDescription(rs.getString(\"forum_desc\"));\n\t\tf.setOrder(rs.getInt(\"forum_order\"));\n\t\tf.setTotalTopics(rs.getInt(\"forum_topics\"));\n\t\tf.setLastPostId(rs.getInt(\"forum_last_post_id\"));\n\t\tf.setModerated(rs.getInt(\"moderated\") > 0);\n\t\tf.setTotalPosts(this.countForumPosts(f.getId()));\n\n\t\treturn f;\n\t}\n\n\tprotected int countForumPosts(int forumId)\n\t{\n\t\tPreparedStatement p = null;\n\t\tResultSet rs = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(\n\t\t\t\t\tSystemGlobals.getSql(\"ForumModel.countForumPosts\"));\n\t\t\tp.setInt(1, forumId);\n\t\t\trs = p.executeQuery();\n\n\t\t\tif (rs.next()) {\n\t\t\t\treturn rs.getInt(1);\n\t\t\t}\n\t\t\t\n\t\t\treturn 0;\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(rs, p);\n\t\t}\n\t}\n\n\t/**\n\t * @see net.jforum.dao.ForumDAO#selectAll()\n\t */\n\tpublic List selectAll()\n\t{\n\t\tPreparedStatement p = null;\n\t\tResultSet rs = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(SystemGlobals.getSql(\"ForumModel.selectAll\"));\n\t\t\tList l = new ArrayList();\n\n\t\t\trs = p.executeQuery();\n\n\t\t\twhile (rs.next()) {\n\t\t\t\tl.add(this.fillForum(rs));\n\t\t\t}\n\n\t\t\treturn l;\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(rs, p);\n\t\t}\n\t}\n\n\t/**\n\t * @see net.jforum.dao.ForumDAO#setOrderUp(Forum, Forum)\n\t */\n\tpublic Forum setOrderUp(Forum forum, Forum related)\n\t{\n\t\treturn this.changeForumOrder(forum, related);\n\t}\n\n\t/**\n\t * @see net.jforum.dao.ForumDAO#setOrderDown(Forum, Forum)\n\t */\n\tpublic Forum setOrderDown(Forum forum, Forum related)\n\t{\n\t\treturn this.changeForumOrder(forum, related);\n\t}\n\n\tprivate Forum changeForumOrder(Forum forum, Forum related)\n\t{\n\t\tint tmpOrder = related.getOrder();\n\t\trelated.setOrder(forum.getOrder());\n\t\tforum.setOrder(tmpOrder);\n\n\t\tPreparedStatement p = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection()\n\t\t\t\t\t.prepareStatement(SystemGlobals.getSql(\"ForumModel.setOrderById\"));\n\t\t\tp.setInt(1, forum.getOrder());\n\t\t\tp.setInt(2, forum.getId());\n\t\t\tp.executeUpdate();\n\t\t\tp.close();\n\t\t\tp = null;\n\n\t\t\tp = JForumExecutionContext.getConnection()\n\t\t\t\t\t.prepareStatement(SystemGlobals.getSql(\"ForumModel.setOrderById\"));\n\t\t\tp.setInt(1, related.getOrder());\n\t\t\tp.setInt(2, related.getId());\n\t\t\tp.executeUpdate();\n\n\t\t\treturn this.selectById(forum.getId());\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(p);\n\t\t}\n\t}\n\n\t/**\n\t * @see net.jforum.dao.ForumDAO#delete(int)\n\t */\n\tpublic void delete(int forumId)\n\t{\n\t\tPreparedStatement p = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(SystemGlobals.getSql(\"ForumModel.delete\"));\n\t\t\tp.setInt(1, forumId);\n\n\t\t\tp.executeUpdate();\n\t\t\t\n\t\t\tGroupSecurityDAO groupSecurity = DataAccessDriver.getInstance().newGroupSecurityDAO();\n\t\t\tgroupSecurity.deleteForumRoles(forumId);\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(p);\n\t\t}\n\t}\n\n\t/**\n\t * @see net.jforum.dao.ForumDAO#update(net.jforum.entities.Forum)\n\t */\n\tpublic void update(Forum forum)\n\t{\n\t\tPreparedStatement p = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(SystemGlobals.getSql(\"ForumModel.update\"));\n\n\t\t\tp.setInt(1, forum.getCategoryId());\n\t\t\tp.setString(2, forum.getName());\n\t\t\tp.setString(3, forum.getDescription());\n\t\t\tp.setInt(4, forum.isModerated() ? 1 : 0);\n\t\t\tp.setInt(5, forum.getId());\n\n\t\t\tp.executeUpdate();\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(p);\n\t\t}\n\t}\n\n\t/**\n\t * @see net.jforum.dao.ForumDAO#addNew(net.jforum.entities.Forum)\n\t */\n\tpublic int addNew(Forum forum)\n\t{\n\t\t// Gets the higher order\n\t\tPreparedStatement pOrder = null;\n\t\tResultSet rs = null;\n\t\ttry {\n\t\t\tpOrder = JForumExecutionContext.getConnection().prepareStatement(\n\t\t\t\t\tSystemGlobals.getSql(\"ForumModel.getMaxOrder\"));\n\t\t\trs = pOrder.executeQuery();\n\n\t\t\tif (rs.next()) {\n\t\t\t\tforum.setOrder(rs.getInt(1) + 1);\n\t\t\t}\n\n\t\t\trs.close();\n\t\t\trs = null;\n\t\t\tpOrder.close();\n\t\t\tpOrder = null;\n\n\t\t\tpOrder = this.getStatementForAutoKeys(\"ForumModel.addNew\");\n\n\t\t\tpOrder.setInt(1, forum.getCategoryId());\n\t\t\tpOrder.setString(2, forum.getName());\n\t\t\tpOrder.setString(3, forum.getDescription());\n\t\t\tpOrder.setInt(4, forum.getOrder());\n\t\t\tpOrder.setInt(5, forum.isModerated() ? 1 : 0);\n\n\t\t\tthis.setAutoGeneratedKeysQuery(SystemGlobals.getSql(\"ForumModel.lastGeneratedForumId\"));\n\t\t\tint forumId = this.executeAutoKeysQuery(pOrder);\n\n\t\t\tforum.setId(forumId);\n\t\t\treturn forumId;\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(rs, pOrder);\n\t\t}\n\t}\n\n\t/**\n\t * @see net.jforum.dao.ForumDAO#setLastPost(int, int)\n\t */\n\tpublic void setLastPost(int forumId, int postId)\n\t{\n\t\tPreparedStatement p = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(\n\t\t\t\t\tSystemGlobals.getSql(\"ForumModel.updateLastPost\"));\n\n\t\t\tp.setInt(1, postId);\n\t\t\tp.setInt(2, forumId);\n\n\t\t\tp.executeUpdate();\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(p);\n\t\t}\n\t}\n\n\t/**\n\t * @see net.jforum.dao.ForumDAO#setTotalTopics(int)\n\t */\n\tpublic void incrementTotalTopics(int forumId, int count)\n\t{\n\t\tPreparedStatement p = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(\n\t\t\t\t\tSystemGlobals.getSql(\"ForumModel.incrementTotalTopics\"));\n\t\t\tp.setInt(1, count);\n\t\t\tp.setInt(2, forumId);\n\t\t\tp.executeUpdate();\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(p);\n\t\t}\n\t}\n\n\t/**\n\t * @see net.jforum.dao.ForumDAO#setTotalTopics(int)\n\t */\n\tpublic void decrementTotalTopics(int forumId, int count)\n\t{\n\t\tPreparedStatement p = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(\n\t\t\t\t\tSystemGlobals.getSql(\"ForumModel.decrementTotalTopics\"));\n\t\t\tp.setInt(1, count);\n\t\t\tp.setInt(2, forumId);\n\t\t\tp.executeUpdate();\n\n\t\t\t// If there are no more topics, then clean the\n\t\t\t// last post id information\n\t\t\tint totalTopics = this.getTotalTopics(forumId);\n\t\t\tif (totalTopics < 1) {\n\t\t\t\tthis.setLastPost(forumId, 0);\n\t\t\t}\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(p);\n\t\t}\n\t}\n\n\tprivate LastPostInfo getLastPostInfo(int forumId, boolean tryFix)\n\t{\n\t\tLastPostInfo lpi = new LastPostInfo();\n\n\t\tPreparedStatement p = null;\n\t\tResultSet rs = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection()\n\t\t\t\t\t.prepareStatement(SystemGlobals.getSql(\"ForumModel.lastPostInfo\"));\n\t\t\tp.setInt(1, forumId);\n\n\t\t\trs = p.executeQuery();\n\n\t\t\tif (rs.next()) {\n\t\t\t\tlpi.setUsername(rs.getString(\"username\"));\n\t\t\t\tlpi.setUserId(rs.getInt(\"user_id\"));\n\n\t\t\t\tSimpleDateFormat df = new SimpleDateFormat(SystemGlobals.getValue(ConfigKeys.DATE_TIME_FORMAT));\n\t\t\t\tlpi.setPostDate(df.format(rs.getTimestamp(\"post_time\")));\n\t\t\t\tlpi.setPostId(rs.getInt(\"post_id\"));\n\t\t\t\tlpi.setTopicId(rs.getInt(\"topic_id\"));\n\t\t\t\tlpi.setPostTimeMillis(rs.getTimestamp(\"post_time\").getTime());\n\t\t\t\tlpi.setTopicReplies(rs.getInt(\"topic_replies\"));\n\n\t\t\t\tlpi.setHasInfo(true);\n\n\t\t\t\t// Check if the topic is consistent\n\t\t\t\tTopicDAO tm = DataAccessDriver.getInstance().newTopicDAO();\n\t\t\t\tTopic t = tm.selectById(lpi.getTopicId());\n\n\t\t\t\tif (t.getId() == 0) {\n\t\t\t\t\t// Hm, that's not good. Try to fix it\n\t\t\t\t\ttm.fixFirstLastPostId(lpi.getTopicId());\n\t\t\t\t}\n\n\t\t\t\ttryFix = false;\n\t\t\t}\n\t\t\telse if (tryFix) {\n\t\t\t\trs.close();\n\t\t\t\trs = null;\n\t\t\t\tp.close();\n\t\t\t\tp = null;\n\n\t\t\t\tint postId = this.getMaxPostId(forumId);\n\n\t\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(\n\t\t\t\t\t\tSystemGlobals.getSql(\"ForumModel.latestTopicIdForfix\"));\n\t\t\t\tp.setInt(1, forumId);\n\t\t\t\trs = p.executeQuery();\n\n\t\t\t\tif (rs.next()) {\n\t\t\t\t\tint topicId;\n\t\t\t\t\ttopicId = rs.getInt(\"topic_id\");\n\n\t\t\t\t\trs.close();\n\t\t\t\t\trs = null;\n\t\t\t\t\tp.close();\n\t\t\t\t\tp = null;\n\n\t\t\t\t\t// Topic\n\t\t\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(\n\t\t\t\t\t\t\tSystemGlobals.getSql(\"ForumModel.fixLatestPostData\"));\n\t\t\t\t\tp.setInt(1, postId);\n\t\t\t\t\tp.setInt(2, topicId);\n\t\t\t\t\tp.executeUpdate();\n\t\t\t\t\tp.close();\n\t\t\t\t\tp = null;\n\n\t\t\t\t\t// Forum\n\t\t\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(\n\t\t\t\t\t\t\tSystemGlobals.getSql(\"ForumModel.fixForumLatestPostData\"));\n\t\t\t\t\tp.setInt(1, postId);\n\t\t\t\t\tp.setInt(2, forumId);\n\t\t\t\t\tp.executeUpdate();\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn (tryFix ? this.getLastPostInfo(forumId, false) : lpi);\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(rs, p);\n\t\t}\n\t}\n\n\t/**\n\t * @see net.jforum.dao.ForumDAO#getLastPostInfo(int)\n\t */\n\tpublic LastPostInfo getLastPostInfo(int forumId)\n\t{\n\t\treturn this.getLastPostInfo(forumId, true);\n\t}\n\n\t/**\n\t * @see net.jforum.dao.ForumDAO#getModeratorList(int)\n\t */\n\tpublic List getModeratorList(int forumId)\n\t{\n\t\tList l = new ArrayList();\n\n\t\tPreparedStatement p = null;\n\t\tResultSet rs = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(\n\t\t\t\t\tSystemGlobals.getSql(\"ForumModel.getModeratorList\"));\n\t\t\tp.setInt(1, forumId);\n\n\t\t\trs = p.executeQuery();\n\n\t\t\twhile (rs.next()) {\n\t\t\t\tModeratorInfo mi = new ModeratorInfo();",
  "metadata": {
    "fileId": "GenericForumDAO_java_chunk_2",
    "fileName": "GenericForumDAO.java",
    "filePath": "src/net/jforum/dao/generic/GenericForumDAO.java"
  }
}