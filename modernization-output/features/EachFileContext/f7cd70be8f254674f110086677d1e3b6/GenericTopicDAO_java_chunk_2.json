{
  "pageContent": "File Path: src/net/jforum/dao/generic/GenericTopicDAO.java\n\n Original Content: public class GenericTopicDAO extends AutoKeys implements TopicDAO\n{\n\t/**\n\t * @see net.jforum.dao.TopicDAO#findTopicsByDateRange(net.jforum.search.SearchArgs)\n\t */\n\tpublic SearchResult findTopicsByDateRange(SearchArgs args) \n\t{\n\t\tSearchResult result = null;\n\t\t\n\t\tPreparedStatement p = null;\n\t\tResultSet rs = null;\n\t\t\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(\n\t\t\t\tSystemGlobals.getSql(\"TopicModel.findTopicsByDateRange\"));\n\t\t\t\n\t\t\tp.setTimestamp(1, new Timestamp(args.getFromDate().getTime()));\n\t\t\tp.setTimestamp(2, new Timestamp(args.getToDate().getTime()));\n\t\t\t\n\t\t\trs = p.executeQuery();\n\t\t\tList l = new ArrayList();\n\t\t\t\n\t\t\tint counter = 0;\n\t\t\t\n\t\t\twhile (rs.next()) {\n\t\t\t\tif (counter >= args.startFrom() && counter < args.startFrom() + args.fetchCount()) {\n\t\t\t\t\tl.add(new Integer(rs.getInt(1)));\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tcounter++;\n\t\t\t}\n\t\t\t\n\t\t\tresult = new SearchResult(this.newMessages(l), counter);\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(rs, p);\n\t\t}\n\t\t\n\t\treturn result;\n\t}\n\t\n\t/**\n\t * @see net.jforum.dao.TopicDAO#fixFirstLastPostId(int)\n\t */\n\tpublic void fixFirstLastPostId(int topicId)\n\t{\n\t\tPreparedStatement p = null;\n\t\tResultSet rs = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(\n\t\t\t\t\tSystemGlobals.getSql(\"TopicModel.getFirstLastPostId\"));\n\t\t\tp.setInt(1, topicId);\n\n\t\t\trs = p.executeQuery();\n\t\t\tif (rs.next()) {\n\t\t\t\tint first = rs.getInt(\"first_post_id\");\n\t\t\t\tint last = rs.getInt(\"last_post_id\");\n\n\t\t\t\trs.close();\n\t\t\t\trs = null;\n\t\t\t\tp.close();\n\t\t\t\tp = null;\n\n\t\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(\n\t\t\t\t\t\tSystemGlobals.getSql(\"TopicModel.fixFirstLastPostId\"));\n\t\t\t\tp.setInt(1, first);\n\t\t\t\tp.setInt(2, last);\n\t\t\t\tp.setInt(3, topicId);\n\t\t\t\tp.executeUpdate();\n\t\t\t}\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(rs, p);\n\t\t}\n\t}\n\n\t/**\n\t * @see net.jforum.dao.TopicDAO#selectById(int)\n\t */\n\tpublic Topic selectById(int topicId)\n\t{\n\t\tPreparedStatement p = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(SystemGlobals.getSql(\"TopicModel.selectById\"));\n\t\t\tp.setInt(1, topicId);\n\n\t\t\tTopic t = new Topic();\n\t\t\tList l = this.fillTopicsData(p);\n\t\t\tp = null;\n\n\t\t\tif (l.size() > 0) {\n\t\t\t\tt = (Topic) l.get(0);\n\t\t\t}\n\n\t\t\treturn t;\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(p);\n\t\t}\n\t}\n\n\t/**\n\t * @see net.jforum.dao.TopicDAO#selectRaw(int)\n\t */\n\tpublic Topic selectRaw(int topicId)\n\t{\n\t\tPreparedStatement p = null;\n\t\tResultSet rs = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(SystemGlobals.getSql(\"TopicModel.selectRaw\"));\n\t\t\tp.setInt(1, topicId);\n\n\t\t\tTopic t = new Topic();\n\t\t\trs = p.executeQuery();\n\t\t\tif (rs.next()) {\n\t\t\t\tt = this.getBaseTopicData(rs);\n\t\t\t}\n\n\t\t\treturn t;\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(rs, p);\n\t\t}\n\t}\n\n\t/**\n\t * @see net.jforum.dao.TopicDAO#delete(net.jforum.entities.Topic)\n\t */\n\tpublic void delete(Topic topic, boolean fromModeration)\n\t{\n\t\tList l = new ArrayList();\n\t\tl.add(topic);\n\t\tthis.deleteTopics(l, fromModeration);\n\t}\n\n\tpublic void deleteTopics(List topics, boolean fromModeration)\n\t{\n\t\t// Topic\n\t\tPreparedStatement p = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(SystemGlobals.getSql(\"TopicModel.delete\"));\n\n\t\t\tForumDAO forumDao = DataAccessDriver.getInstance().newForumDAO();\n\n\t\t\tPostDAO postDao = DataAccessDriver.getInstance().newPostDAO();\n\t\t\tPollDAO pollDao = DataAccessDriver.getInstance().newPollDAO();\n\n\t\t\tfor (Iterator iter = topics.iterator(); iter.hasNext();) {\n\t\t\t\tTopic topic = (Topic) iter.next();\n\n\t\t\t\t// Remove watches\n\t\t\t\tthis.removeSubscriptionByTopic(topic.getId());\n\n\t\t\t\t// Remove the messages\n\t\t\t\tpostDao.deleteByTopic(topic.getId());\n\n\t\t\t\t// Remove the poll\n\t\t\t\tpollDao.deleteByTopicId(topic.getId());\n\n\t\t\t\t// Delete the topic itself\n\t\t\t\tp.setInt(1, topic.getId());\n\t\t\t\tp.executeUpdate();\n\n\t\t\t\tif (!fromModeration) {\n\t\t\t\t\tforumDao.decrementTotalTopics(topic.getForumId(), 1);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(p);\n\t\t}\n\n\t}\n\n\t/**\n\t * @see net.jforum.dao.TopicDAO#deleteByForum(int)\n\t */\n\tpublic void deleteByForum(int forumId)\n\t{\n\t\tPreparedStatement p = null;\n\t\tResultSet rs = null;\n\t\t\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(\n\t\t\t\t\tSystemGlobals.getSql(\"TopicModel.deleteByForum\"));\n\t\t\tp.setInt(1, forumId);\n\n\t\t\trs = p.executeQuery();\n\t\t\tList topics = new ArrayList();\n\t\t\t\n\t\t\twhile (rs.next()) {\n\t\t\t\tTopic t = new Topic();\n\t\t\t\tt.setId(rs.getInt(\"topic_id\"));\n\t\t\t\tt.setForumId(forumId);\n\n\t\t\t\ttopics.add(t);\n\t\t\t}\n\n\t\t\tthis.deleteTopics(topics, false);\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(rs, p);\n\t\t}\n\t}\n\n\t/**\n\t * @see net.jforum.dao.TopicDAO#update(net.jforum.entities.Topic)\n\t */\n\tpublic void update(Topic topic)\n\t{\n\t\tPreparedStatement p = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(SystemGlobals.getSql(\"TopicModel.update\"));\n\n\t\t\tp.setString(1, topic.getTitle());\n\t\t\tp.setInt(2, topic.getLastPostId());\n\t\t\tp.setInt(3, topic.getFirstPostId());\n\t\t\tp.setInt(4, topic.getType());\n\t\t\tp.setInt(5, topic.isModerated() ? 1 : 0);\n\t\t\tp.setInt(6, topic.getVoteId());\n\t\t\tp.setInt(7, topic.getId());\n\t\t\tp.executeUpdate();\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(p);\n\t\t}\n\n\t}\n\n\t/**\n\t * @see net.jforum.dao.TopicDAO#addNew(net.jforum.entities.Topic)\n\t */\n\tpublic int addNew(Topic topic)\n\t{\n\t\tPreparedStatement p = null;\n\t\t\n\t\ttry {\n\t\t\tp = this.getStatementForAutoKeys(\"TopicModel.addNew\");\n\n\t\t\tp.setInt(1, topic.getForumId());\n\t\t\tp.setString(2, topic.getTitle());\n\t\t\tp.setInt(3, topic.getPostedBy().getId());\n\t\t\tp.setTimestamp(4, new Timestamp(topic.getTime().getTime()));\n\t\t\tp.setInt(5, topic.getFirstPostId());\n\t\t\tp.setInt(6, topic.getLastPostId());\n\t\t\tp.setInt(7, topic.getType());\n\t\t\tp.setInt(8, topic.isModerated() ? 1 : 0);\n\n\t\t\tthis.setAutoGeneratedKeysQuery(SystemGlobals.getSql(\"TopicModel.lastGeneratedTopicId\"));\n\t\t\t\n\t\t\tint topicId = this.executeAutoKeysQuery(p);\n\t\t\t\n\t\t\ttopic.setId(topicId);\n\t\t\t\n\t\t\treturn topicId;\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(p);\n\t\t}\n\t}\n\n\t/**\n\t * @see net.jforum.dao.TopicDAO#incrementTotalViews(int)\n\t */\n\tpublic void incrementTotalViews(int topicId)\n\t{\n\t\tPreparedStatement p = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(\n\t\t\t\tSystemGlobals.getSql(\"TopicModel.incrementTotalViews\"));\n\t\t\tp.setInt(1, topicId);\n\t\t\tp.executeUpdate();\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(p);\n\t\t}\n\t}\n\n\t/**\n\t * @see net.jforum.dao.TopicDAO#incrementTotalReplies(int)\n\t */\n\tpublic void incrementTotalReplies(int topicId)\n\t{\n\t\tPreparedStatement p = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(\n\t\t\t\t\tSystemGlobals.getSql(\"TopicModel.incrementTotalReplies\"));\n\t\t\tp.setInt(1, topicId);\n\t\t\tp.executeUpdate();\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(p);\n\t\t}\n\t}\n\n\t/**\n\t * @see net.jforum.dao.TopicDAO#decrementTotalReplies(int)\n\t */\n\tpublic void decrementTotalReplies(int topicId)\n\t{\n\t\tPreparedStatement p = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(\n\t\t\t\t\tSystemGlobals.getSql(\"TopicModel.decrementTotalReplies\"));\n\t\t\tp.setInt(1, topicId);\n\t\t\tp.executeUpdate();\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(p);\n\t\t}\n\t}\n\n\t/**\n\t * @see net.jforum.dao.TopicDAO#setLastPostId(int, int)\n\t */\n\tpublic void setLastPostId(int topicId, int postId)\n\t{\n\t\tPreparedStatement p = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(\n\t\t\t\t\tSystemGlobals.getSql(\"TopicModel.setLastPostId\"));\n\t\t\tp.setInt(1, postId);\n\t\t\tp.setInt(2, topicId);\n\t\t\tp.executeUpdate();\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(p);\n\t\t}\n\t}\n\n\t/**\n\t * @see net.jforum.dao.TopicDAO#selectAllByForum(int)\n\t */\n\tpublic List selectAllByForum(int forumId)\n\t{\n\t\treturn this.selectAllByForumByLimit(forumId, 0, Integer.MAX_VALUE);\n\t}\n\n\t/**\n\t * @see net.jforum.dao.TopicDAO#selectAllByForumByLimit(int, int, int)\n\t */\n\tpublic List selectAllByForumByLimit(int forumId, int startFrom, int count)\n\t{\n\t\tString sql = SystemGlobals.getSql(\"TopicModel.selectAllByForumByLimit\");\n\n\t\tPreparedStatement p = null;\n\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(sql);\n\t\t\tp.setInt(1, forumId);\n\t\t\tp.setInt(2, forumId);\n\t\t\tp.setInt(3, startFrom);\n\t\t\tp.setInt(4, count);\n\n\t\t\treturn this.fillTopicsData(p);\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(p);\n\t\t}\n\t}\n\n\t/**\n\t * @see net.jforum.dao.TopicDAO#selectByUserByLimit(int, int, int)\n\t */\n\tpublic List selectByUserByLimit(int userId, int startFrom, int count)\n\t{\n\t\tPreparedStatement p = null;\n\t\ttry {\n\t\t\tp = JForumExecutionContext.getConnection().prepareStatement(\n\t\t\t\t\tSystemGlobals.getSql(\"TopicModel.selectByUserByLimit\").replaceAll(\":fids:\",\n\t\t\t\t\t\t\tForumRepository.getListAllowedForums()));\n\n\t\t\tp.setInt(1, userId);\n\t\t\tp.setInt(2, startFrom);\n\t\t\tp.setInt(3, count);\n\n\t\t\tList list = this.fillTopicsData(p);\n\t\t\tp = null;\n\t\t\treturn list;\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new DatabaseException(e);\n\t\t}\n\t\tfinally {\n\t\t\tDbUtils.close(p);\n\t\t}\n\t}\n\n\t/**\n\t * @see net.jforum.dao.TopicDAO#countUserTopics(int)\n\t */\n\tpublic int countUserTopics(int userId)\n\t{\n\t\tint total = 0;",
  "metadata": {
    "fileId": "GenericTopicDAO_java_chunk_2",
    "fileName": "GenericTopicDAO.java",
    "filePath": "src/net/jforum/dao/generic/GenericTopicDAO.java"
  }
}