{
  "pageContent": "File Path: src/net/jforum/view/forum/PostAction.java\n\n Original Content: Post postPreview = new Post(p);\n\t\t\tthis.context.put(\"postPreview\", PostCommon.preparePostForDisplay(postPreview));\n\n\t\t\tthis.insert();\n\t\t}\n\t}\n\n\tprivate int startPage(Topic t, int currentStart) {\n\t\tint postsPerPage = SystemGlobals.getIntValue(ConfigKeys.POSTS_PER_PAGE);\n\n\t\tint newStart = (t.getTotalReplies() + 1) / postsPerPage * postsPerPage;\n\t\t\n\t\treturn (newStart > currentStart) ? newStart : currentStart;\n\t}\n\n\tpublic void delete()\n\t{\n\t\tif (!SecurityRepository.canAccess(SecurityConstants.PERM_MODERATION_POST_REMOVE)) {\n\t\t\tthis.setTemplateName(TemplateKeys.POSTS_CANNOT_DELETE);\n\t\t\tthis.context.put(\"message\", I18n.getMessage(\"CannotRemovePost\"));\n\n\t\t\treturn;\n\t\t}\n\n\t\t// Post\n\t\tPostDAO postDao = DataAccessDriver.getInstance().newPostDAO();\n\t\tPost p = postDao.selectById(this.request.getIntParameter(\"post_id\"));\n\t\t\n\t\tif (p.getId() == 0) {\n\t\t\tthis.postNotFound();\n\t\t\treturn;\n\t\t}\n\n\t\tTopicDAO topicDao = DataAccessDriver.getInstance().newTopicDAO();\n\t\tTopic t = topicDao.selectRaw(p.getTopicId());\n\n\t\tif (!TopicsCommon.isTopicAccessible(t.getForumId())) {\n\t\t\treturn;\n\t\t}\n\n\t\tpostDao.delete(p);\n\t\tDataAccessDriver.getInstance().newUserDAO().decrementPosts(p.getUserId());\n\t\t\n\t\t// Karma\n\t\tKarmaDAO karmaDao = DataAccessDriver.getInstance().newKarmaDAO();\n\t\tkarmaDao.updateUserKarma(p.getUserId());\n\t\t\n\t\t// Attachments\n\t\tnew AttachmentCommon(this.request, p.getForumId()).deleteAttachments(p.getId(), p.getForumId());\n\n\t\t// It was the last remaining post in the topic?\n\t\tint totalPosts = topicDao.getTotalPosts(p.getTopicId());\n\n\t\tif (totalPosts > 0) {\n\t\t\t// Topic\n\t\t\ttopicDao.decrementTotalReplies(p.getTopicId());\n\n\t\t\tint maxPostId = topicDao.getMaxPostId(p.getTopicId());\n\t\t\tif (maxPostId > -1) {\n\t\t\t\ttopicDao.setLastPostId(p.getTopicId(), maxPostId);\n\t\t\t}\n\n\t\t\tint minPostId = topicDao.getMinPostId(p.getTopicId());\n\t\t\tif (minPostId > -1) {\n\t\t\t  topicDao.setFirstPostId(p.getTopicId(), minPostId);\n\t\t\t}\n\t        \n\t\t\t// Forum\n\t\t\tForumDAO fm = DataAccessDriver.getInstance().newForumDAO();\n\n\t\t\tmaxPostId = fm.getMaxPostId(p.getForumId());\n\t\t\tif (maxPostId > -1) {\n\t\t\t\tfm.setLastPost(p.getForumId(), maxPostId);\n\t\t\t}\n\n\t\t\tString returnPath = this.request.getContextPath() + \"/posts/list/\";\n\n\t\t\tint page = ViewCommon.getStartPage();\n\t\t\t\n\t\t\tif (page > 0) {\n\t\t\t\tint postsPerPage = SystemGlobals.getIntValue(ConfigKeys.POSTS_PER_PAGE);\n\n\t\t\t\tif (totalPosts % postsPerPage == 0) {\n\t\t\t\t\tpage -= postsPerPage;\n\t\t\t\t}\n\n\t\t\t\treturnPath += page + \"/\";\n\t\t\t}\n\n\t\t\tJForumExecutionContext.setRedirect(returnPath \n\t\t\t\t+ p.getTopicId() \n\t\t\t\t+ SystemGlobals.getValue(ConfigKeys.SERVLET_EXTENSION));\n\t\t\t\n\t\t\t// Update the cache\n\t\t\tif (TopicRepository.isTopicCached(t)) {\n\t\t\t\tt = topicDao.selectById(t.getId());\n\t\t\t\tTopicRepository.updateTopic(t);\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\t// Ok, all posts were removed. Time to say goodbye\n\t\t\tTopicsCommon.deleteTopic(p.getTopicId(), p.getForumId(), false);\n\n\t\t\tJForumExecutionContext.setRedirect(this.request.getContextPath() \n\t\t\t\t+ \"/forums/show/\" \n\t\t\t\t+ p.getForumId()\n\t\t\t\t+ SystemGlobals.getValue(ConfigKeys.SERVLET_EXTENSION));\n\t\t}\n\t\t\n\t\tthis.request.addOrReplaceParameter(\"log_original_message\", p.getText());\n\t\tModerationHelper moderationHelper = new ModerationHelper();\n\t\tModerationLog moderationLog = moderationHelper.buildModerationLogFromRequest();\n\t\tmoderationLog.getPosterUser().setId(p.getUserId());\n\t\tmoderationHelper.saveModerationLog(moderationLog);\n\t\t\n\t\tPostRepository.remove(t.getId(), p.getId());\n\t\tTopicRepository.loadMostRecentTopics();\n\t\tTopicRepository.loadHottestTopics();\n\t\tForumRepository.reloadForum(p.getForumId());\n\t}\n\n\tprivate void watch(TopicDAO tm, int topicId, int userId)  \n\t{\n\t\tif (!tm.isUserSubscribed(topicId, userId)) {\n\t\t\ttm.subscribeUser(topicId, userId);\n\t\t}\n\t}\n\n\tpublic void watch()  \n\t{\n\t\tint topicId = this.request.getIntParameter(\"topic_id\");\n\t\tint userId = SessionFacade.getUserSession().getUserId();\n\n\t\tthis.watch(DataAccessDriver.getInstance().newTopicDAO(), topicId, userId);\n\t\tthis.list();\n\t}\n\n\tpublic void unwatch()  \n\t{\n\t\tif (!SessionFacade.isLogged()) {\n\t\t\tthis.setTemplateName(ViewCommon.contextToLogin());\n\t\t}\n\t\telse {\n\t\t\tint topicId = this.request.getIntParameter(\"topic_id\");\n\t\t\tint userId = SessionFacade.getUserSession().getUserId();\n\t\t\tint start = ViewCommon.getStartPage();\n\n\t\t\tDataAccessDriver.getInstance().newTopicDAO().removeSubscription(topicId, userId);\n\n\t\t\tString returnPath = this.request.getContextPath() + \"/posts/list/\";\n\t\t\t\n\t\t\tif (start > 0) {\n\t\t\t\treturnPath += start + \"/\";\n\t\t\t}\n\n\t\t\treturnPath += topicId + SystemGlobals.getValue(ConfigKeys.SERVLET_EXTENSION);\n\n\t\t\tthis.setTemplateName(TemplateKeys.POSTS_UNWATCH);\n\t\t\tthis.context.put(\"pageTitle\", I18n.getMessage(\"PostShow.unwatch\"));\n\t\t\tthis.context.put(\"message\", I18n.getMessage(\"ForumBase.unwatched\", new String[] { returnPath }));\n\t\t}\n\t}\n\t\n\tpublic void downloadAttach()\n\t{\n\t\tint id = this.request.getIntParameter(\"attach_id\");\n\t\t\n\t\tif (!SessionFacade.isLogged() && !SystemGlobals.getBoolValue(ConfigKeys.ATTACHMENTS_ANONYMOUS)) {\n\t\t\tString referer = this.request.getHeader(\"Referer\");\n\t\t\t\n\t\t\tif (referer != null) {\n\t\t\t\tthis.setTemplateName(ViewCommon.contextToLogin(referer));\n\t\t\t}\n\t\t\telse {\n\t\t\t\tthis.setTemplateName(ViewCommon.contextToLogin());\n\t\t\t}\n\t\t\t\n\t\t\treturn;\n\t\t}\n\t\t\n\t\tAttachmentDAO am = DataAccessDriver.getInstance().newAttachmentDAO();\n\t\tAttachment a = am.selectAttachmentById(id);\n\t\t\n\t\tPostDAO postDao = DataAccessDriver.getInstance().newPostDAO();\n\t\tPost post = postDao.selectById(a.getPostId());\n\t\t\n\t\tString forumId = Integer.toString(post.getForumId());\n\t\t\n\t\tboolean attachmentsEnabled = SecurityRepository.canAccess(SecurityConstants.PERM_ATTACHMENTS_ENABLED, forumId);\n\t\tboolean attachmentsDownload = SecurityRepository.canAccess(SecurityConstants.PERM_ATTACHMENTS_DOWNLOAD, forumId);\n\t\t\n\t\tif (!attachmentsEnabled && !attachmentsDownload) {\n\t\t\tthis.setTemplateName(TemplateKeys.POSTS_CANNOT_DOWNLOAD);\n\t\t\tthis.context.put(\"message\", I18n.getMessage(\"Attachments.featureDisabled\"));\n\t\t\treturn;\n\t\t}\n\t\t\n\t\tString filename = SystemGlobals.getValue(ConfigKeys.ATTACHMENTS_STORE_DIR)\n\t\t\t+ \"/\"\n\t\t\t+ a.getInfo().getPhysicalFilename();\n\n\t\tif (!new File(filename).exists()) {\n\t\t\tthis.setTemplateName(TemplateKeys.POSTS_ATTACH_NOTFOUND);\n\t\t\tthis.context.put(\"message\", I18n.getMessage(\"Attachments.notFound\"));\n\t\t\treturn;\n\t\t}\n\t\t\n\t\tFileInputStream fis = null;\n\t\tOutputStream os = null;\n\n\t\ttry {\n\t\t\ta.getInfo().setDownloadCount(a.getInfo().getDownloadCount() + 1);\n\t\t\tam.updateAttachment(a);\n\n\t\t\tfis = new FileInputStream(filename);\n\t\t\tos = response.getOutputStream();\n\n\t\t\tif (am.isPhysicalDownloadMode(a.getInfo().getExtension().getExtensionGroupId())) {\n\t\t\t\tthis.response.setContentType(\"application/octet-stream\");\n\t\t\t}\n\t\t\telse {\n\t\t\t\tthis.response.setContentType(a.getInfo().getMimetype());\n\t\t\t}\n\n\t\t\tif (this.request.getHeader(\"User-Agent\").indexOf(\"Firefox\") != -1) {\n\t\t\t\tthis.response.setHeader(\"Content-Disposition\", \"attachment; filename=\\\"\"\n\t\t\t\t\t+ new String(a.getInfo().getRealFilename().getBytes(SystemGlobals.getValue(ConfigKeys.ENCODING)),\n\t\t\t\t\t\tSystemGlobals.getValue(ConfigKeys.DEFAULT_CONTAINER_ENCODING)) + \"\\\";\");\n\t\t\t}\n\t\t\telse {\n\t\t\t\tthis.response.setHeader(\"Content-Disposition\", \"attachment; filename=\\\"\"\n\t\t\t\t\t+ ViewCommon.toUtf8String(a.getInfo().getRealFilename()) + \"\\\";\");\n\t\t\t}\n\n\t\t\tthis.response.setContentLength((int)a.getInfo().getFilesize());\n\n\t\t\tint c;\n\t\t\tbyte[] b = new byte[4096];\n\t\t\twhile ((c = fis.read(b)) != -1) {\n\t\t\t\tos.write(b, 0, c);\n\t\t\t}\n\n\t\t\t\n\t\t\tJForumExecutionContext.enableCustomContent(true);\n\t\t}\n\t\tcatch (IOException e) {\n\t\t\tthrow new ForumException(e);\n\t\t}\n\t\tfinally {\n\t\t\tif (fis != null) {\n\t\t\t\ttry { fis.close(); }\n\t\t\t\tcatch (Exception e) {}\n\t\t\t}\n\t\t\t\n\t\t\tif (os != null) {\n\t\t\t\ttry { os.close(); }\n\t\t\t\tcatch (Exception e) {}\n\t\t\t}\n\t\t}\n\t}\n\t\n\tprivate void cannotEdit()\n\t{\n\t\tthis.setTemplateName(TemplateKeys.POSTS_EDIT_CANNOTEDIT);\n\t\tthis.context.put(\"message\", I18n.getMessage(\"CannotEditPost\"));\n\t}\n\t\n\tprivate void topicLocked() \n\t{\n\t\tthis.setTemplateName(TemplateKeys.POSTS_TOPIC_LOCKED);\n\t\tthis.context.put(\"message\", I18n.getMessage(\"PostShow.topicLocked\"));\n\t}\n\t\n\tpublic void listSmilies()\n\t{\n\t\tthis.setTemplateName(SystemGlobals.getValue(ConfigKeys.TEMPLATE_DIR) + \"/empty.htm\");\n\t\tthis.setTemplateName(TemplateKeys.POSTS_LIST_SMILIES);\n\t\tthis.context.put(\"smilies\", SmiliesRepository.getSmilies());\n\t}\n\n\tprivate boolean isForumReadonly(int forumId, boolean isReply) {\n\t\tif (!SecurityRepository.canAccess(SecurityConstants.PERM_READ_ONLY_FORUMS, Integer.toString(forumId))) {\n\t\t\tif (isReply) {\n\t\t\t\tthis.list();\n\t\t\t}\n\t\t\telse {\n\t\t\t\tJForumExecutionContext.setRedirect(this.request.getContextPath() + \"/forums/show/\" + forumId\n\t\t\t\t\t+ SystemGlobals.getValue(ConfigKeys.SERVLET_EXTENSION));\n\t\t\t}\n\n\t\t\treturn true;\n\t\t}\n\n\t\treturn false;\n\t}\n\t\n\tprivate boolean anonymousPost(int forumId)  \n\t{\n\t\t// Check if anonymous posts are allowed\n\t\tif (!SessionFacade.isLogged()\n\t\t\t\t&& !SecurityRepository.canAccess(SecurityConstants.PERM_ANONYMOUS_POST, Integer.toString(forumId))) {\n\t\t\tthis.setTemplateName(ViewCommon.contextToLogin());\n\n\t\t\treturn false;\n\t\t}\n\n\t\treturn true;\n\t}\n}",
  "metadata": {
    "fileId": "PostAction_java_chunk_6",
    "fileName": "PostAction.java",
    "filePath": "src/net/jforum/view/forum/PostAction.java"
  }
}