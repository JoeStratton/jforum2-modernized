{
  "pageContent": "File Path: src/net/jforum/view/forum/ModerationAction.java\n\n Original Content: /*\n * Copyright (c) JForum Team\n * All rights reserved.\n * \n * Redistribution and use in source and binary forms, \n * with or without modification, are permitted provided \n * that the following conditions are met:\n * \n * 1) Redistributions of source code must retain the above \n * copyright notice, this list of conditions and the \n * following  disclaimer.\n * 2)  Redistributions in binary form must reproduce the \n * above copyright notice, this list of conditions and \n * the following disclaimer in the documentation and/or \n * other materials provided with the distribution.\n * 3) Neither the name of \"Rafael Steil\" nor \n * the names of its contributors may be used to endorse \n * or promote products derived from this software without \n * specific prior written permission.\n * \n * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT \n * HOLDERS AND CONTRIBUTORS \"AS IS\" AND ANY \n * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, \n * BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF \n * MERCHANTABILITY AND FITNESS FOR A PARTICULAR \n * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL \n * THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE \n * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, \n * EXEMPLARY, OR CONSEQUENTIAL DAMAGES \n * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF \n * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, \n * OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER \n * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER \n * IN CONTRACT, STRICT LIABILITY, OR TORT \n * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN \n * ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF \n * ADVISED OF THE POSSIBILITY OF SUCH DAMAGE\n * \n * Created on 02/10/2005 20:04:15\n * The JForum Project\n * http://www.jforum.net\n */\npackage net.jforum.view.forum;\n\nimport java.util.Iterator;\nimport java.util.List;\n\nimport net.jforum.Command;\nimport net.jforum.JForumExecutionContext;\nimport net.jforum.dao.DataAccessDriver;\nimport net.jforum.dao.ModerationLogDAO;\nimport net.jforum.dao.PostDAO;\nimport net.jforum.dao.TopicDAO;\nimport net.jforum.entities.ModerationLog;\nimport net.jforum.entities.Post;\nimport net.jforum.entities.Topic;\nimport net.jforum.repository.ForumRepository;\nimport net.jforum.repository.SecurityRepository;\nimport net.jforum.security.SecurityConstants;\nimport net.jforum.util.I18n;\nimport net.jforum.util.preferences.ConfigKeys;\nimport net.jforum.util.preferences.SystemGlobals;\nimport net.jforum.util.preferences.TemplateKeys;\nimport net.jforum.view.forum.common.PostCommon;\nimport net.jforum.view.forum.common.ViewCommon;\n\n/**\n * @author Rafael Steil\n * @version $Id: ModerationAction.java,v 1.6 2007/07/28 14:17:09 rafaelsteil Exp $\n */\npublic class ModerationAction extends Command\n{\n\t/**\n\t * @throws UnsupportedOperationException always\n\t * @see net.jforum.Command#list()\n\t */\n\tpublic void list()\n\t{\n\t\tthrow new UnsupportedOperationException();\n\t}\n\t\n\tpublic void showActivityLog() \n\t{\n\t\tif (!SecurityRepository.canAccess(SecurityConstants.PERM_MODERATION_LOG)) {\n\t\t\tthis.denied();\n\t\t\treturn;\n\t\t}\n\t\t\n\t\tModerationLogDAO dao = DataAccessDriver.getInstance().newModerationLogDAO();\n\t\t\n\t\tint start = ViewCommon.getStartPage();\n\t\tint recordsPerPage = SystemGlobals.getIntValue(ConfigKeys.TOPICS_PER_PAGE);\n\t\t\n\t\tList list = dao.selectAll(start, recordsPerPage);\n\t\tboolean canAccessFullModerationLog = SecurityRepository.canAccess(SecurityConstants.PERM_FULL_MODERATION_LOG);\n\t\t\n\t\tPostDAO postDao = DataAccessDriver.getInstance().newPostDAO();\n\t\tTopicDAO topicDao = DataAccessDriver.getInstance().newTopicDAO();\n\t\t\n\t\tfor (Iterator iter = list.iterator(); iter.hasNext();) {\n\t\t\tModerationLog log = (ModerationLog)iter.next();\n\t\t\t\n\t\t\tif (log.getPostId() > 0) {\n\t\t\t\tPost post = postDao.selectById(log.getPostId());\n\t\t\t\t\n\t\t\t\tif (post.getId() > 0 && ForumRepository.getForum(post.getForumId()) == null) {\n\t\t\t\t\titer.remove();\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t}\n\t\t\telse if (log.getTopicId() > 0) {\n\t\t\t\tTopic topic = topicDao.selectRaw(log.getTopicId());\n\t\t\t\t\n\t\t\t\tif (topic.getId() > 0 && ForumRepository.getForum(topic.getForumId()) == null) {\n\t\t\t\t\titer.remove();\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\tif (log.getOriginalMessage() != null && canAccessFullModerationLog) {\n\t\t\t\tPost post = new Post();\n\t\t\t\tpost.setText(log.getOriginalMessage());\n\t\t\t\t\n\t\t\t\tlog.setOriginalMessage(PostCommon.preparePostForDisplay(post).getText());\n\t\t\t}\n\t\t}\n\t\t\n\t\tthis.setTemplateName(TemplateKeys.MODERATION_SHOW_ACTIVITY_LOG);\n\t\tthis.context.put(\"activityLog\", list);\n\t\tthis.context.put(\"canAccessFullModerationLog\", canAccessFullModerationLog);\n\t\t\n\t\tint totalRecords = dao.totalRecords();\n\t\t\n\t\tViewCommon.contextToPagination(start, totalRecords, recordsPerPage);\n\t}\n\t\n\tprivate void denied() {\n\t\tthis.setTemplateName(TemplateKeys.MODERATION_LOG_DENIED);\n\t\tthis.context.put(\"message\", I18n.getMessage(\"ModerationLog.denied\"));\n\t}\n\t\n\tpublic void doModeration()\n\t{\n\t\tString returnUrl = this.request.getParameter(\"returnUrl\");\n\t\t\n\t\tnew ModerationHelper().doModeration(returnUrl);\n\t\t\n\t\tthis.context.put(\"returnUrl\", returnUrl);\n\t\t\n\t\tif (JForumExecutionContext.getRequest().getParameter(\"topicMove\") != null) {\n\t\t\tthis.setTemplateName(TemplateKeys.MODERATION_MOVE_TOPICS);\n\t\t}\n\t}\n\t\n\tpublic void moveTopic()\n\t{\n\t\tnew ModerationHelper().moveTopicsSave(this.request.getParameter(\"returnUrl\"));\n\t}\n\t\n\tpublic void moderationDone()\n\t{\n\t\tthis.setTemplateName(new ModerationHelper().moderationDone(this.request.getParameter(\"returnUrl\")));\n\t}\n}",
  "metadata": {
    "fileId": "ModerationAction_java_chunk_1",
    "fileName": "ModerationAction.java",
    "filePath": "src/net/jforum/view/forum/ModerationAction.java"
  }
}