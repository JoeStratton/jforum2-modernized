{
  "pageContent": "File Path: src/net/jforum/view/forum/PostAction.java\n\n Original Content: if (this.request.getParameter(\"notify\") == null) {\n\t\t\t\ttopicDao.removeSubscription(post.getTopicId(), SessionFacade.getUserSession().getUserId());\n\t\t\t}\n\n\t\t\tString path = this.request.getContextPath() + \"/posts/list/\";\n\t\t\tint start = ViewCommon.getStartPage();\n\t\t\t\n\t\t\tif (start > 0) {\n\t\t\t\tpath += start + \"/\";\n\t\t\t}\n\n\t\t\tpath += post.getTopicId() + SystemGlobals.getValue(ConfigKeys.SERVLET_EXTENSION) + \"#\" + post.getId();\n\t\t\tJForumExecutionContext.setRedirect(path);\n\t\t\t\n\t\t\tif (SystemGlobals.getBoolValue(ConfigKeys.POSTS_CACHE_ENABLED)) {\n\t\t\t\tPostRepository.update(post.getTopicId(), PostCommon.preparePostForDisplay(post));\n\t\t\t}\n\t\t}\n\t}\n\t\n\tprivate boolean ensurePollMinimumOptions(Post p, Poll poll)\n\t{\n\t\tif (poll.getOptions().size() < 2) {\n\t\t\t// It is not a valid poll, cancel the post\n\t\t\tJForumExecutionContext.enableRollback();\n\t\t\tp.setText(this.request.getParameter(\"message\"));\n\t\t\tp.setId(0);\n\t\t\tthis.context.put(\"errorMessage\", I18n.getMessage(\"PostForm.needMorePollOptions\"));\n\t\t\tthis.context.put(\"post\", p);\n\t\t\tthis.context.put(\"poll\", poll);\n\t\t\tthis.edit();\n\t\t\treturn false;\n\t\t}\n\t\t\n\t\treturn true;\n\t}\n\t\n\tpublic void waitingModeration()\n\t{\n\t\tthis.setTemplateName(TemplateKeys.POSTS_WAITING);\n\t\t\n\t\tint topicId = this.request.getIntParameter(\"topic_id\");\n\t\tString path = this.request.getContextPath();\n\t\t\n\t\tif (topicId == 0) {\n\t\t\tpath += \"/forums/show/\" + this.request.getParameter(\"forum_id\");\n\t\t}\n\t\telse {\n\t\t\tpath += \"/posts/list/\" + topicId;\n\t\t}\n\t\t\n\t\tthis.context.put(\"message\", I18n.getMessage(\"PostShow.waitingModeration\", \n\t\t\t\tnew String[] { path + SystemGlobals.getValue(ConfigKeys.SERVLET_EXTENSION) }));\n\t}\n\t\n\tprivate void notModeratedYet()\n\t{\n\t\tthis.setTemplateName(TemplateKeys.POSTS_NOT_MODERATED);\n\t\tthis.context.put(\"message\", I18n.getMessage(\"PostShow.notModeratedYet\"));\n\t}\n\n\tpublic void insertSave()\n\t{\n\t\tint forumId = this.request.getIntParameter(\"forum_id\");\n\t\tboolean firstPost = false;\n\n\t\tif (!this.anonymousPost(forumId)) {\n\t\t\treturn;\n\t\t}\n\t\t\n\t\tTopic t = new Topic(-1);\n\t\tt.setForumId(forumId);\n\n\t\tboolean newTopic = (this.request.getParameter(\"topic_id\") == null);\n\t\t\n\t\tif (!TopicsCommon.isTopicAccessible(t.getForumId())\n\t\t\t\t|| this.isForumReadonly(t.getForumId(), newTopic)) {\n\t\t\treturn;\n\t\t}\n\n\t\tTopicDAO topicDao = DataAccessDriver.getInstance().newTopicDAO();\n\t\tPostDAO postDao = DataAccessDriver.getInstance().newPostDAO();\n\t\tPollDAO poolDao = DataAccessDriver.getInstance().newPollDAO();\n\t\tForumDAO forumDao = DataAccessDriver.getInstance().newForumDAO();\n\n\t\tif (!newTopic) {\n\t\t\tint topicId = this.request.getIntParameter(\"topic_id\");\n\t\t\t\n\t\t\tt = TopicRepository.getTopic(new Topic(topicId));\n\t\t\t\n\t\t\tif (t == null) {\n\t\t\t\tt = topicDao.selectById(topicId);\n\t\t\t}\n\t\t\t\n\t\t\t// Could not find the topic. The topicId sent was invalid\n\t\t\tif (t == null || t.getId() == 0) {\n\t\t\t\tnewTopic = true;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tif (!TopicsCommon.isTopicAccessible(t.getForumId())) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\n\t\t\t\t// Cannot insert new messages on locked topics\n\t\t\t\tif (t.getStatus() == Topic.STATUS_LOCKED) {\n\t\t\t\t\tthis.topicLocked();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t\n\t\t// We don't use \"else if\" here because there is a possibility of the\n\t\t// checking above set the newTopic var to true\n\t\tif (newTopic) {\n\t\t\tif (this.isReplyOnly(forumId)) {\n\t\t\t\tthis.replyOnly();\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t\n\t\t\tif (this.request.getParameter(\"topic_type\") != null) {\n\t\t\t\tt.setType(this.request.getIntParameter(\"topic_type\"));\n\t\t\t\t\n\t\t\t\tif (t.getType() != Topic.TYPE_NORMAL \n\t\t\t\t\t\t&& !SecurityRepository.canAccess(SecurityConstants.PERM_CREATE_STICKY_ANNOUNCEMENT_TOPICS)) {\n\t\t\t\t\tt.setType(Topic.TYPE_NORMAL);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t\n\t\tUserSession us = SessionFacade.getUserSession();\n\t\tUser u = DataAccessDriver.getInstance().newUserDAO().selectById(us.getUserId());\n\t\t\n\t\tif (\"1\".equals(this.request.getParameter(\"quick\")) && SessionFacade.isLogged()) {\n\t\t\tthis.request.addParameter(\"notify\", u.isNotifyOnMessagesEnabled() ? \"1\" : null);\n\t\t\tthis.request.addParameter(\"attach_sig\", u.getAttachSignatureEnabled() ? \"1\" : \"0\");\n\t\t}\n\t\telse {\n\t\t\tu.setId(us.getUserId());\n\t\t\tu.setUsername(us.getUsername());\n\t\t}\n\n\t\t// Set the Post\n\t\tPost p = PostCommon.fillPostFromRequest();\n\t\t\n\t\tif (p.getText() == null || p.getText().trim().equals(\"\")) {\n\t\t\tthis.insert();\n\t\t\treturn;\n\t\t}\n\t\t\n\t\t// Check the elapsed time since the last post from the user\n\t\tint delay = SystemGlobals.getIntValue(ConfigKeys.POSTS_NEW_DELAY);\n\t\t\n\t\tif (delay > 0) {\n\t\t\tLong lastPostTime = (Long)SessionFacade.getAttribute(ConfigKeys.LAST_POST_TIME);\n\t\t\t\n\t\t\tif (lastPostTime != null) {\n\t\t\t\tif (System.currentTimeMillis() < (lastPostTime.longValue() + delay)) {\n\t\t\t\t\tthis.context.put(\"post\", p);\n\t\t\t\t\tthis.context.put(\"start\", this.request.getParameter(\"start\"));\n\t\t\t\t\tthis.context.put(\"error\", I18n.getMessage(\"PostForm.tooSoon\"));\n\t\t\t\t\tthis.insert();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t\n\t\tp.setForumId(this.request.getIntParameter(\"forum_id\"));\n\t\t\n\t\tif (StringUtils.isBlank(p.getSubject())) {\n\t\t\tp.setSubject(t.getTitle());\n\t\t}\n\t\t\n\t\tboolean needCaptcha = SystemGlobals.getBoolValue(ConfigKeys.CAPTCHA_POSTS)\n\t\t\t&& request.getSessionContext().getAttribute(ConfigKeys.REQUEST_IGNORE_CAPTCHA) == null;\n\t\t\n\t\tif (needCaptcha) {\n\t\t\tif (!us.validateCaptchaResponse(this.request.getParameter(\"captcha_anwser\"))) {\n\t\t\t\tthis.context.put(\"post\", p);\n\t\t\t\tthis.context.put(\"start\", this.request.getParameter(\"start\"));\n\t\t\t\tthis.context.put(\"error\", I18n.getMessage(\"CaptchaResponseFails\"));\n\t\t\t\t\n\t\t\t\tthis.insert();\n\t\t\t\t\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tboolean preview = \"1\".equals(this.request.getParameter(\"preview\"));\n\t\t\n\t\tif (!preview) {\n\t\t\tAttachmentCommon attachments = new AttachmentCommon(this.request, forumId);\n\t\t\t\n\t\t\ttry {\n\t\t\t\tattachments.preProcess();\n\t\t\t}\n\t\t\tcatch (AttachmentException e) {\n\t\t\t\tJForumExecutionContext.enableRollback();\n\t\t\t\tp.setText(this.request.getParameter(\"message\"));\n\t\t\t\tp.setId(0);\n\t\t\t\tthis.context.put(\"errorMessage\", e.getMessage());\n\t\t\t\tthis.context.put(\"post\", p);\n\t\t\t\tthis.insert();\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t\n\t\t\tForum forum = ForumRepository.getForum(forumId);\n\t\t\tPermissionControl pc = SecurityRepository.get(us.getUserId());\n\n\t\t\t// Moderators and admins don't need to have their messages moderated\n\t\t\tboolean moderate = (forum.isModerated() \n\t\t\t\t&& !pc.canAccess(SecurityConstants.PERM_MODERATION)\n\t\t\t\t&& !pc.canAccess(SecurityConstants.PERM_ADMINISTRATION));\n\t\t\t\n\t\t\tif (newTopic) {\n\t\t\t\tt.setTime(new Date());\n\t\t\t\tt.setTitle(this.request.getParameter(\"subject\"));\n\t\t\t\tt.setModerated(moderate);\n\t\t\t\tt.setPostedBy(u);\n\t\t\t\tt.setFirstPostTime(ViewCommon.formatDate(t.getTime()));\n\n\t\t\t\tint topicId = topicDao.addNew(t);\n\t\t\t\tt.setId(topicId);\n\t\t\t\tfirstPost = true;\n\t\t\t}\n\t\t\t\n\t\t\tif (!firstPost && pc.canAccess(\n\t\t\t\t\tSecurityConstants.PERM_REPLY_WITHOUT_MODERATION, Integer.toString(t.getForumId()))) {\n\t\t\t\tmoderate = false;\n\t\t\t}\n\n\t\t\t// Topic watch\n\t\t\tif (this.request.getParameter(\"notify\") != null) {\n\t\t\t\tthis.watch(topicDao, t.getId(), u.getId());\n\t\t\t}\n\n\t\t\tp.setTopicId(t.getId());\n\n\t\t\t// add a poll\n\t\t\tPoll poll = PollCommon.fillPollFromRequest();\n\t\t\t\n\t\t\tif (poll != null && newTopic) {\n\t\t\t\tpoll.setTopicId(t.getId());\n\t\t\t\t\n\t\t\t\tif (poll.getOptions().size() < 2) {\n\t\t\t\t\t//it is not a valid poll, cancel the post\n\t\t\t\t\tJForumExecutionContext.enableRollback();\n\t\t\t\t\tp.setText(this.request.getParameter(\"message\"));\n\t\t\t\t\tp.setId(0);\n\t\t\t\t\tthis.context.put(\"errorMessage\", I18n.getMessage(\"PostForm.needMorePollOptions\"));\n\t\t\t\t\tthis.context.put(\"post\", p);\n\t\t\t\t\tthis.context.put(\"poll\", poll);\n\t\t\t\t\tthis.insert();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tpoolDao.addNew(poll);\n\t\t\t\tt.setVoteId(poll.getId());\n\t\t\t}\n\n\t\t\t// Save the remaining stuff\n\t\t\tp.setModerate(moderate);\n\t\t\tint postId = postDao.addNew(p);\n\n\t\t\tif (newTopic) {\n\t\t\t\tt.setFirstPostId(postId);\n\t\t\t}\n\t\t\t\n\t\t\tif (!moderate) {\n\t\t\t\tt.setLastPostId(postId);\n\t\t\t\tt.setLastPostBy(u);\n\t\t\t\tt.setLastPostDate(p.getTime());\n\t\t\t\tt.setLastPostTime(p.getFormatedTime());\n\t\t\t}\n\t\t\t\n\t\t\ttopicDao.update(t);\n\t\t\t\n\t\t\tattachments.insertAttachments(p);\n\t\t\t\n\t\t\tif (!moderate) {\n\t\t\t\tStringBuffer path = new StringBuffer(512);\n\t\t\t\tpath.append(this.request.getContextPath()).append(\"/posts/list/\");\n\t\t\t\t\n\t\t\t\tint start = ViewCommon.getStartPage();\n\t\n\t\t\t\tpath.append(this.startPage(t, start)).append(\"/\")\n\t\t\t\t\t.append(t.getId()).append(SystemGlobals.getValue(ConfigKeys.SERVLET_EXTENSION))\n\t\t\t\t\t.append('#').append(postId);\n\t\n\t\t\t\tJForumExecutionContext.setRedirect(path.toString());\n\t\t\t\t\n\t\t\t\tif (newTopic) {\n\t\t\t\t\t// Notify \"forum new topic\" users\n\t\t\t\t\tForumCommon.notifyUsers(forum, t, p);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tt.setTotalReplies(t.getTotalReplies() + 1);\n\t\t\t\t\tTopicsCommon.notifyUsers(t, p);\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t// Update forum stats, cache and etc\n\t\t\t\tt.setTotalViews(t.getTotalViews() + 1);\n\t\t\t\t\n\t\t\t\tDataAccessDriver.getInstance().newUserDAO().incrementPosts(p.getUserId());\n\t\t\t\t\n\t\t\t\tTopicsCommon.updateBoardStatus(t, postId, firstPost, topicDao, forumDao);\n\t\t\t\tForumRepository.updateForumStats(t, u, p);\n\t\t\t\t\n\t\t\t\tint anonymousUser = SystemGlobals.getIntValue(ConfigKeys.ANONYMOUS_USER_ID);\n\t\t\t\t\n\t\t\t\tif (u.getId() != anonymousUser) {\n\t\t\t\t\tSessionFacade.getTopicsReadTime().put(new Integer(t.getId()),\n\t\t\t\t\t\tnew Long(p.getTime().getTime()));\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tif (SystemGlobals.getBoolValue(ConfigKeys.POSTS_CACHE_ENABLED)) {\n\t\t\t\t\tSimpleDateFormat df = new SimpleDateFormat(SystemGlobals.getValue(ConfigKeys.DATE_TIME_FORMAT));\n\t\t\t\t\tp.setFormatedTime(df.format(p.getTime()));\n\t\t\t\t\t\n\t\t\t\t\tPostRepository.append(p.getTopicId(), PostCommon.preparePostForDisplay(p));\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\tJForumExecutionContext.setRedirect(this.request.getContextPath() \n\t\t\t\t\t+ \"/posts/waitingModeration/\" \n\t\t\t\t\t+ (firstPost ? 0 : t.getId())\n\t\t\t\t\t+ \"/\" + t.getForumId()\n\t\t\t\t\t+ SystemGlobals.getValue(ConfigKeys.SERVLET_EXTENSION));\n\t\t\t}\n\t\t\t\n\t\t\tif (delay > 0) {\n\t\t\t\tSessionFacade.setAttribute(ConfigKeys.LAST_POST_TIME, new Long(System.currentTimeMillis()));\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tthis.context.put(\"preview\", true);\n\t\t\tthis.context.put(\"post\", p);\n\t\t\tthis.context.put(\"start\", this.request.getParameter(\"start\"));",
  "metadata": {
    "fileId": "PostAction_java_chunk_5",
    "fileName": "PostAction.java",
    "filePath": "src/net/jforum/view/forum/PostAction.java"
  }
}