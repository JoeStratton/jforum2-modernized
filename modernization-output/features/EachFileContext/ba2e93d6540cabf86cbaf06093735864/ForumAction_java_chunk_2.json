{
  "pageContent": "File Path: src/net/jforum/view/forum/ForumAction.java\n\n Original Content: public class ForumAction extends Command\n{\n\t/**\n\t * List all the forums (first page of forum index)?\n\t */\n\tpublic void list()\n\t{\n\t\tthis.setTemplateName(TemplateKeys.FORUMS_LIST);\n\n\t\tthis.context.put(\"allCategories\", ForumCommon.getAllCategoriesAndForums(true));\n\t\tthis.context.put(\"topicsPerPage\", new Integer(SystemGlobals.getIntValue(ConfigKeys.TOPICS_PER_PAGE)));\n\t\tthis.context.put(\"rssEnabled\", SystemGlobals.getBoolValue(ConfigKeys.RSS_ENABLED));\n\n\t\tthis.context.put(\"totalMessages\", new Integer(ForumRepository.getTotalMessages()));\n\t\tthis.context.put(\"totalRegisteredUsers\", ForumRepository .totalUsers());\n\t\tthis.context.put(\"lastUser\", ForumRepository.lastRegisteredUser());\n\n\t\tSimpleDateFormat df = new SimpleDateFormat(SystemGlobals.getValue(ConfigKeys.DATE_TIME_FORMAT));\n\t\tGregorianCalendar gc = new GregorianCalendar();\n\t\tthis.context.put(\"now\", df.format(gc.getTime()));\n\n\t\tthis.context.put(\"lastVisit\", df.format(SessionFacade.getUserSession().getLastVisit()));\n\t\tthis.context.put(\"forumRepository\", new ForumRepository());\n\n\t\t// Online Users\n\t\tthis.context.put(\"totalOnlineUsers\", new Integer(SessionFacade.size()));\n\t\tint aid = SystemGlobals.getIntValue(ConfigKeys.ANONYMOUS_USER_ID);\n\n\t\tList onlineUsersList = SessionFacade.getLoggedSessions();\n\n\t\t// Check for an optional language parameter\n\t\tUserSession currentUser = SessionFacade.getUserSession();\n\n\t\tif (currentUser.getUserId() == aid) {\n\t\t\tString lang = this.request.getParameter(\"lang\");\n\n\t\t\tif (lang != null && I18n.languageExists(lang)) {\n\t\t\t\tcurrentUser.setLang(lang);\n\t\t\t}\n\t\t}\n\n\t\t// If there are only guest users, then just register\n\t\t// a single one. In any other situation, we do not\n\t\t// show the \"guest\" username\n\t\tif (onlineUsersList.size() == 0) {\n\t\t\tUserSession us = new UserSession();\n\n\t\t\tus.setUserId(aid);\n\t\t\tus.setUsername(I18n.getMessage(\"Guest\"));\n\n\t\t\tonlineUsersList.add(us);\n\t\t}\n\n\t\tint registeredSize = SessionFacade.registeredSize();\n\t\tint anonymousSize = SessionFacade.anonymousSize();\n\t\tint totalOnlineUsers = registeredSize + anonymousSize;\n\n\t\tthis.context.put(\"userSessions\", onlineUsersList);\n\t\tthis.context.put(\"totalOnlineUsers\", new Integer(totalOnlineUsers));\n\t\tthis.context.put(\"totalRegisteredOnlineUsers\", new Integer(registeredSize));\n\t\tthis.context.put(\"totalAnonymousUsers\", new Integer(anonymousSize));\n\n\t\t// Most users ever online\n\t\tMostUsersEverOnline mostUsersEverOnline = ForumRepository.getMostUsersEverOnline();\n\n\t\tif (totalOnlineUsers > mostUsersEverOnline.getTotal()) {\n\t\t\tmostUsersEverOnline.setTotal(totalOnlineUsers);\n\t\t\tmostUsersEverOnline.setTimeInMillis(System.currentTimeMillis());\n\n\t\t\tForumRepository.updateMostUsersEverOnline(mostUsersEverOnline);\n\t\t}\n\n\t\tthis.context.put(\"mostUsersEverOnline\", mostUsersEverOnline);\n\t}\n\n\tpublic void moderation()\n\t{\n\t\tthis.context.put(\"openModeration\", true);\n\t\tthis.show();\n\t}\n\n\t/**\n\t * Display all topics in a forum\n\t */\n\tpublic void show()\n\t{\n\t\tint forumId = this.request.getIntParameter(\"forum_id\");\n\t\tForumDAO fm = DataAccessDriver.getInstance().newForumDAO();\n\n\t\t// The user can access this forum?\n\t\tForum forum = ForumRepository.getForum(forumId);\n\n\t\tif (forum == null || !ForumRepository.isCategoryAccessible(forum.getCategoryId())) {\n\t\t\tnew ModerationHelper().denied(I18n.getMessage(\"ForumListing.denied\"));\n\t\t\treturn;\n\t\t}\n\n\t\tint start = ViewCommon.getStartPage();\n\n\t\tList tmpTopics = TopicsCommon.topicsByForum(forumId, start);\n\n\t\tthis.setTemplateName(TemplateKeys.FORUMS_SHOW);\n\n\t\t// Moderation\n\t\tUserSession userSession = SessionFacade.getUserSession();\n\t\tboolean isLogged = SessionFacade.isLogged();\n\t\tboolean isModerator = userSession.isModerator(forumId);\n\n\t\tboolean canApproveMessages = (isLogged && isModerator \n\t\t\t&& SecurityRepository.canAccess(SecurityConstants.PERM_MODERATION_APPROVE_MESSAGES));\n\n\t\tMap topicsToApprove = new HashMap();\n\n\t\tif (canApproveMessages) {\n\t\t\tModerationDAO mdao = DataAccessDriver.getInstance().newModerationDAO();\n\t\t\ttopicsToApprove = mdao.topicsByForum(forumId);\n\t\t\tthis.context.put(\"postFormatter\", new PostCommon());\n\t\t}\n\n\t\tthis.context.put(\"topicsToApprove\", topicsToApprove);\n\n\t\tthis.context.put(\"attachmentsEnabled\", SecurityRepository.canAccess(SecurityConstants.PERM_ATTACHMENTS_ENABLED,\n\t\t        Integer.toString(forumId))\n\t\t        || SecurityRepository.canAccess(SecurityConstants.PERM_ATTACHMENTS_DOWNLOAD));\n\n\t\tthis.context.put(\"topics\", TopicsCommon.prepareTopics(tmpTopics));\n\t\tthis.context.put(\"allCategories\", ForumCommon.getAllCategoriesAndForums(false));\n\t\tthis.context.put(\"forum\", forum);\n\t\tthis.context.put(\"rssEnabled\", SystemGlobals.getBoolValue(ConfigKeys.RSS_ENABLED));\n\t\tthis.context.put(\"pageTitle\", forum.getName());\n\t\tthis.context.put(\"canApproveMessages\", canApproveMessages);\n\t\tthis.context.put(\"replyOnly\", !SecurityRepository.canAccess(SecurityConstants.PERM_REPLY_ONLY, Integer\n\t\t        .toString(forum.getId())));\n\n\t\tthis.context.put(\"readonly\", !SecurityRepository.canAccess(SecurityConstants.PERM_READ_ONLY_FORUMS, Integer\n\t\t        .toString(forumId)));\n\n\t\tthis.context.put(\"watching\", fm.isUserSubscribed(forumId, userSession.getUserId()));\n\n\t\t// Pagination\n\t\tint topicsPerPage = SystemGlobals.getIntValue(ConfigKeys.TOPICS_PER_PAGE);\n\t\tint postsPerPage = SystemGlobals.getIntValue(ConfigKeys.POSTS_PER_PAGE);\n\t\tint totalTopics = forum.getTotalTopics();\n\n\t\tViewCommon.contextToPagination(start, totalTopics, topicsPerPage);\n\t\tthis.context.put(\"postsPerPage\", new Integer(postsPerPage));\n\n\t\tTopicsCommon.topicListingBase();\n\t\tthis.context.put(\"moderator\", isLogged && isModerator);\n\t}\n\n\t// Make an URL to some action\n\tprivate String makeRedirect(String action)\n\t{\n\t\tString path = this.request.getContextPath() + \"/forums/\" + action + \"/\";\n\t\tString thisPage = this.request.getParameter(\"start\");\n\n\t\tif (thisPage != null && !thisPage.equals(\"0\")) {\n\t\t\tpath += thisPage + \"/\";\n\t\t}\n\n\t\tString forumId = this.request.getParameter(\"forum_id\");\n\n\t\tif (forumId == null) {\n\t\t\tforumId = this.request.getParameter(\"persistData\");\n\t\t}\n\n\t\tpath += forumId + SystemGlobals.getValue(ConfigKeys.SERVLET_EXTENSION);\n\n\t\treturn path;\n\t}\n\n\t// Mark all topics as read\n\tpublic void readAll()\n\t{\n\t\tString forumId = this.request.getParameter(\"forum_id\");\n\t\t\n\t\tif (forumId != null) {\n\t\t\tMap tracking = SessionFacade.getTopicsReadTimeByForum();\n\t\t\t\n\t\t\tif (tracking == null) {\n\t\t\t\ttracking = new HashMap();\n\t\t\t}\n\t\t\t\n\t\t\ttracking.put(new Integer(forumId), new Long(System.currentTimeMillis()));\n\t\t\tSessionFacade.setAttribute(ConfigKeys.TOPICS_READ_TIME_BY_FORUM, tracking);\n\t\t}\n\n\t\tif (forumId != null) {\n\t\t\tJForumExecutionContext.setRedirect(this.makeRedirect(\"show\"));\n\t\t}\n\t\telse {\n\t\t\tJForumExecutionContext.setRedirect(this.request.getContextPath() + \"/forums/list\"\n\t\t        + SystemGlobals.getValue(ConfigKeys.SERVLET_EXTENSION));\n\t\t}\n\t}\n\n\t// Messages since last visit\n\tpublic void newMessages()\n\t{\n\t\tthis.request.addParameter(\"from_date\", SessionFacade.getUserSession().getLastVisit());\n\t\tthis.request.addParameter(\"to_date\", new Date());\n\n\t\tSearchAction searchAction = new SearchAction(this.request, this.response, this.context);\n\t\tsearchAction.newMessages();\n\t\t\n\t\tthis.setTemplateName(TemplateKeys.SEARCH_NEW_MESSAGES);\n\t}\n\n\tpublic void approveMessages()\n\t{\n\t\tif (SessionFacade.getUserSession().isModerator(this.request.getIntParameter(\"forum_id\"))) {\n\t\t\tnew ModerationAction(this.context, this.request).doSave();\n\t\t}\n\n\t\tJForumExecutionContext.setRedirect(this.request.getContextPath() + \"/forums/show/\"\n\t\t\t+ this.request.getParameter(\"forum_id\") + SystemGlobals.getValue(ConfigKeys.SERVLET_EXTENSION));\n\t}\n\n\t/**\n\t * Action when users click on \"watch this forum\"\n\t * It gets teh forum_id and userId, and put them into a watch_forum table in the database;\n\t */\n\tpublic void watchForum()\n\t{\n\t\tint forumId = this.request.getIntParameter(\"forum_id\");\n\t\tint userId = SessionFacade.getUserSession().getUserId();\n\n\t\tthis.watchForum(DataAccessDriver.getInstance().newForumDAO(), forumId, userId);\n\n\t\tJForumExecutionContext.setRedirect(this.redirectLinkToShowAction(forumId));\n\t}\n\n\tpublic void banned()\n\t{\n\t\tthis.setTemplateName(TemplateKeys.FORUMS_BANNED);\n\t\tthis.context.put(\"message\", I18n.getMessage(\"ForumBanned.banned\"));\n\t}\n\n\tprivate String redirectLinkToShowAction(int forumId)\n\t{\n\t\tint start = ViewCommon.getStartPage();\n\n\t\treturn this.request.getContextPath() + \"/forums/show/\" + (start > 0 ? start + \"/\" : \"\") + forumId\n\t\t\t+ SystemGlobals.getValue(ConfigKeys.SERVLET_EXTENSION);\n\t}\n\n\t/**\n\t * \n\t * @param dao ForumDAO\n\t * @param forumId int\n\t * @param userId int\n\t */\n\tprivate void watchForum(ForumDAO dao, int forumId, int userId)\n\t{\n\t\tif (SessionFacade.isLogged() && !dao.isUserSubscribed(forumId, userId)) {\n\t\t\tdao.subscribeUser(forumId, userId);\n\t\t}\n\t}\n\n\t/**\n\t * Unwatch the forum watched.\n\t */\n\tpublic void unwatchForum()\n\t{\n\t\tif (SessionFacade.isLogged()) {\n\t\t\tint forumId = this.request.getIntParameter(\"forum_id\");\n\t\t\tint userId = SessionFacade.getUserSession().getUserId();\n\n\t\t\tDataAccessDriver.getInstance().newForumDAO().removeSubscription(forumId, userId);\n\n\t\t\tString returnPath = this.redirectLinkToShowAction(forumId);\n\n\t\t\tthis.setTemplateName(TemplateKeys.POSTS_UNWATCH);\n\t\t\tthis.context.put(\"message\", I18n.getMessage(\"ForumBase.forumUnwatched\", new String[] { returnPath }));\n\t\t}\n\t\telse {\n\t\t\tthis.setTemplateName(ViewCommon.contextToLogin());\n\t\t}\n\t}\n}",
  "metadata": {
    "fileId": "ForumAction_java_chunk_2",
    "fileName": "ForumAction.java",
    "filePath": "src/net/jforum/view/forum/ForumAction.java"
  }
}