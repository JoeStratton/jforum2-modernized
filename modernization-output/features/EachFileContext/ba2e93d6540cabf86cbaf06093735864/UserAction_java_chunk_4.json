{
  "pageContent": "File Path: src/net/jforum/view/forum/UserAction.java\n\n Original Content: // Lost password form\n\tpublic void lostPassword() \n\t{\n\t\tthis.setTemplateName(TemplateKeys.USER_LOSTPASSWORD);\n\t\tthis.context.put(\"pageTitle\", I18n.getMessage(\"PasswordRecovery.title\"));\n\t}\n\t\n\tpublic User prepareLostPassword(String username, String email)\n\t{\n\t\tUser user = null;\n\t\tUserDAO um = DataAccessDriver.getInstance().newUserDAO();\n\n\t\tif (email != null && !email.trim().equals(\"\")) {\n\t\t\tusername = um.getUsernameByEmail(email);\n\t\t}\n\n\t\tif (username != null && !username.trim().equals(\"\")) {\n\t\t\tList l = um.findByName(username, true);\n\t\t\tif (l.size() > 0) {\n\t\t\t\tuser = (User)l.get(0);\n\t\t\t}\n\t\t}\n\t\t\n\t\tif (user == null) {\n\t\t\treturn null;\n\t\t}\n\t\t\n\t\tString hash = MD5.crypt(user.getEmail() \n\t\t\t+ System.currentTimeMillis() \n\t\t\t+ SystemGlobals.getValue(ConfigKeys.USER_HASH_SEQUENCE)\n\t\t\t+ new Random().nextInt(999999));\n\n\t\tum.writeLostPasswordHash(user.getEmail(), hash);\n\t\t\n\t\tuser.setActivationKey(hash);\n\t\t\n\t\treturn user;\n\t}\n\n\t// Send lost password email\n\tpublic void lostPasswordSend()\n\t{\n\t\tString email = this.request.getParameter(\"email\");\n\t\tString username = this.request.getParameter(\"username\");\n\n\t\tUser user = this.prepareLostPassword(username, email);\n\t\tif (user == null) {\n\t\t\t// user could not be found\n\t\t\tthis.context.put(\"message\",\n\t\t\t\t\tI18n.getMessage(\"PasswordRecovery.invalidUserEmail\"));\n\t\t\tthis.lostPassword();\n\t\t\treturn;\n\t\t}\n\t\t\n\t\tExecutor.execute(new EmailSenderTask(\n\t\t\t\tnew LostPasswordSpammer(user, \n\t\t\t\t\tSystemGlobals.getValue(ConfigKeys.MAIL_LOST_PASSWORD_SUBJECT))));\n\n\t\tthis.setTemplateName(TemplateKeys.USER_LOSTPASSWORD_SEND);\n\t\tthis.context.put(\"message\", I18n.getMessage(\n\t\t\t\"PasswordRecovery.emailSent\",\n\t\t\tnew String[] { \n\t\t\t\t\tthis.request.getContextPath()\n\t\t\t\t\t+ \"/user/login\"\n\t\t\t\t\t+ SystemGlobals.getValue(ConfigKeys.SERVLET_EXTENSION) \n\t\t\t\t}));\n\t}\n\n\t// Recover user password ( aka, ask him a new one )\n\tpublic void recoverPassword()\n\t{\n\t\tString hash = this.request.getParameter(\"hash\");\n\n\t\tthis.setTemplateName(TemplateKeys.USER_RECOVERPASSWORD);\n\t\tthis.context.put(\"recoverHash\", hash);\n\t}\n\n\tpublic void recoverPasswordValidate()\n\t{\n\t\tString hash = this.request.getParameter(\"recoverHash\");\n\t\tString email = this.request.getParameter(\"email\");\n\n\t\tString message;\n\t\tboolean isOk = DataAccessDriver.getInstance().newUserDAO().validateLostPasswordHash(email, hash);\n\t\t\n\t\tif (isOk) {\n\t\t\tString password = this.request.getParameter(\"newPassword\");\n\t\t\tDataAccessDriver.getInstance().newUserDAO().saveNewPassword(MD5.crypt(password), email);\n\n\t\t\tmessage = I18n.getMessage(\"PasswordRecovery.ok\",\n\t\t\t\tnew String[] { this.request.getContextPath()\n\t\t\t\t\t+ \"/user/login\"\n\t\t\t\t\t+ SystemGlobals.getValue(ConfigKeys.SERVLET_EXTENSION) });\n\t\t} \n\t\telse {\n\t\t\tmessage = I18n.getMessage(\"PasswordRecovery.invalidData\");\n\t\t}\n\n\t\tthis.setTemplateName(TemplateKeys.USER_RECOVERPASSWORD_VALIDATE);\n\t\tthis.context.put(\"message\", message);\n\t}\n\n\t\t\n\tpublic void list()\n\t{\n\t\tint start = this.preparePagination(DataAccessDriver.getInstance().newUserDAO().getTotalUsers());\n\t\tint usersPerPage = SystemGlobals.getIntValue(ConfigKeys.USERS_PER_PAGE);\n\t\t\t\t\t\t\t\n\t\tList users = DataAccessDriver.getInstance().newUserDAO().selectAll(start ,usersPerPage);\n\t\tthis.context.put(\"users\", users);\n\t\tthis.context.put(\"pageTitle\", I18n.getMessage(\"ForumBase.usersList\"));\n\t\tthis.setTemplateName(TemplateKeys.USER_LIST);\n\t}\n\n\tpublic void listGroup()\n\t{\n\t\tint groupId = this.request.getIntParameter(\"group_id\");\n\t\t\n\t\tint start = this.preparePagination(DataAccessDriver.getInstance().newUserDAO().getTotalUsersByGroup(groupId));\n\t\tint usersPerPage = SystemGlobals.getIntValue(ConfigKeys.USERS_PER_PAGE);\n\t\t\t\t\t\t\t\n\t\tList users = DataAccessDriver.getInstance().newUserDAO().selectAllByGroup(groupId, start ,usersPerPage);\n\t\t\n\t\tthis.context.put(\"users\", users);\n\t\tthis.setTemplateName(TemplateKeys.USER_LIST);\n\t}\n\t\n\t/**\n\t * @deprecated probably will be removed. Use KarmaAction to load Karma\n\t */\n\tpublic void searchKarma() \n\t{\n\t\tint start = this.preparePagination(DataAccessDriver.getInstance().newUserDAO().getTotalUsers());\n\t\tint usersPerPage = SystemGlobals.getIntValue(ConfigKeys.USERS_PER_PAGE);\n\t\t\n\t\t//Load all users with your karma\n\t\tList users = DataAccessDriver.getInstance().newUserDAO().selectAllWithKarma(start ,usersPerPage);\n\t\tthis.context.put(\"users\", users);\n\t\tthis.setTemplateName(TemplateKeys.USER_SEARCH_KARMA);\n\t}\n\t\n\t\n\tprivate int preparePagination(int totalUsers)\n\t{\n\t\tint start = ViewCommon.getStartPage();\n\t\tint usersPerPage = SystemGlobals.getIntValue(ConfigKeys.USERS_PER_PAGE);\n\t\t\n\t\tViewCommon.contextToPagination(start, totalUsers, usersPerPage);\n\t\t\n\t\treturn start;\n\t}\t\n}",
  "metadata": {
    "fileId": "UserAction_java_chunk_4",
    "fileName": "UserAction.java",
    "filePath": "src/net/jforum/view/forum/UserAction.java"
  }
}