{
  "pageContent": "File Path: src/net/jforum/view/forum/PrivateMessageAction.java\n\n Original Content: if (totalMessages > 0) {\n\t\t\t\t\tus.setPrivateMessages(totalMessages - 1);\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\tUser u = pm.getFromUser();\n\t\t\tViewCommon.prepareUserSignature(u);\n            \n\t\t\tthis.context.put(\"pm\", pm);\n\t\t\tthis.setTemplateName(TemplateKeys.PM_READ);\n\t\t}\n\t\telse {\n\t\t\tthis.setTemplateName(TemplateKeys.PM_READ_DENIED);\n\t\t\tthis.context.put(\"message\", I18n.getMessage(\"PrivateMessage.readDenied\"));\n\t\t}\n\t}\n\t\n\tpublic void review()\n\t{\n\t\tthis.read();\n\t\tthis.setTemplateName(TemplateKeys.PM_READ_REVIEW);\n\t}\n\t\n\tpublic void delete()\n\t{\n\t\tif (!SessionFacade.isLogged()) {\n\t\t\tthis.setTemplateName(ViewCommon.contextToLogin());\n\t\t\treturn;\n\t\t}\n\t\t\n\t\tString ids[] = this.request.getParameterValues(\"id\");\n\t\t\n\t\tif (ids != null && ids.length > 0) {\n\t\t\tPrivateMessage[] deleteList = new PrivateMessage[ids.length];\n\t\t\t\n\t\t\tint unreadCount = 0;\n\t\t\tPrivateMessageDAO dao = DataAccessDriver.getInstance().newPrivateMessageDAO();\n\t\t\t\n\t\t\tfor (int i = 0; i < ids.length; i++) {\n\t\t\t\tPrivateMessage pm = dao.selectById(new PrivateMessage(Integer.parseInt(ids[i])));\n\t\t\t\t\n\t\t\t\tif (pm.getType() == PrivateMessageType.NEW) {\n\t\t\t\t\tunreadCount++;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tdeleteList[i] = pm;\n\t\t\t}\n\t\t\t\n\t\t\tUserSession userSession = SessionFacade.getUserSession();\n\t\t\t\n\t\t\tdao.delete(deleteList, userSession.getUserId());\n\t\t\t\n\t\t\t// Subtracts the number of delete messages\n\t\t\tint total = userSession.getPrivateMessages() - unreadCount;\n\t\t\t\n\t\t\tif (total < 0) {\n\t\t\t\ttotal = 0;\n\t\t\t}\n\t\t\t\n\t\t\tuserSession.setPrivateMessages(total);\n\t\t}\n\t\t\n\t\tthis.setTemplateName(TemplateKeys.PM_DELETE);\n\t\tthis.context.put(\"message\", I18n.getMessage(\"PrivateMessage.deleteDone\", \n\t\t\tnew String[] { this.request.getContextPath() \n\t\t\t\t+ \"/pm/inbox\"\n\t\t\t\t+ SystemGlobals.getValue(ConfigKeys.SERVLET_EXTENSION) }));\n\t}\n\t\n\tpublic void reply()\n\t{\n\t\tif (!SessionFacade.isLogged()) {\n\t\t\tthis.setTemplateName(ViewCommon.contextToLogin());\n\t\t\treturn;\n\t\t}\n\t\t\n\t\tint id = this.request.getIntParameter(\"id\");\n\t\t\n\t\tPrivateMessage pm = new PrivateMessage();\n\t\tpm.setId(id);\n\t\tpm = DataAccessDriver.getInstance().newPrivateMessageDAO().selectById(pm);\n\t\t\n\t\tint userId = SessionFacade.getUserSession().getUserId();\n\t\t\n\t\tif (pm.getToUser().getId() != userId && pm.getFromUser().getId() != userId) {\n\t\t\tthis.setTemplateName(TemplateKeys.PM_READ_DENIED);\n\t\t\tthis.context.put(\"message\", I18n.getMessage(\"PrivateMessage.readDenied\"));\n\t\t\treturn;\n\t\t}\n\t\t\n\t\tpm.getPost().setSubject(I18n.getMessage(\"PrivateMessage.replyPrefix\") + pm.getPost().getSubject());\n\t\t\n\t\tthis.context.put(\"pm\", pm);\n\t\tthis.context.put(\"pmReply\", true);\n\t\t\n\t\tthis.sendFormCommon(DataAccessDriver.getInstance().newUserDAO().selectById(\n\t\t\t\tSessionFacade.getUserSession().getUserId()));\n\t}\n\t\n\tpublic void quote()\n\t{\n\t\tif (!SessionFacade.isLogged()) {\n\t\t\tthis.setTemplateName(ViewCommon.contextToLogin());\n\t\t\treturn;\n\t\t}\n\t\t\n\t\tint id = this.request.getIntParameter(\"id\");\n\t\t\n\t\tPrivateMessage pm = new PrivateMessage();\n\t\tpm.setId(id);\n\t\tpm = DataAccessDriver.getInstance().newPrivateMessageDAO().selectById(pm);\n\n\t\tint userId = SessionFacade.getUserSession().getUserId();\n\t\t\n\t\tif (pm.getToUser().getId() != userId && pm.getFromUser().getId() != userId) {\n\t\t\tthis.setTemplateName(TemplateKeys.PM_READ_DENIED);\n\t\t\tthis.context.put(\"message\", I18n.getMessage(\"PrivateMessage.readDenied\"));\n\t\t\treturn;\n\t\t}\n\t\t\n\t\tpm.getPost().setSubject(I18n.getMessage(\"PrivateMessage.replyPrefix\") + pm.getPost().getSubject());\n\t\t\n\t\tthis.sendFormCommon(DataAccessDriver.getInstance().newUserDAO().selectById(userId));\n\t\t\n\t\tthis.context.put(\"quote\", \"true\");\n\t\tthis.context.put(\"quoteUser\", pm.getFromUser().getUsername());\n\t\tthis.context.put(\"post\", pm.getPost());\n\t\tthis.context.put(\"pm\", pm);\n\t}\n\t\n\t/** \n\t * @see net.jforum.Command#list()\n\t */\n\tpublic void list()\n\t{\n\t\tthis.inbox();\n\t}\n}",
  "metadata": {
    "fileId": "PrivateMessageAction_java_chunk_3",
    "fileName": "PrivateMessageAction.java",
    "filePath": "src/net/jforum/view/forum/PrivateMessageAction.java"
  }
}